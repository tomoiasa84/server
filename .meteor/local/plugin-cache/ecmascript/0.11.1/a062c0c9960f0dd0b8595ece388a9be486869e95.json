{"metadata":{},"options":{"plugins":[{"key":"base$0$0","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"generateLetDeclarations":true,"enforceStrictMode":false}},{"key":"transform-meteor-dynamic-import","visitor":{"_exploded":{},"_verified":{},"CallExpression":{"enter":[null]}},"options":{}},{"key":"base$0$2","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"polyfill":false,"useBuiltIns":true}},{"key":"base$0$3","visitor":{"_exploded":{},"_verified":{},"PrivateName":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]}},"options":{"loose":true}},{"key":"base$0$4","visitor":{"Program":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"allowTopLevelThis":true,"strictMode":false,"loose":true}},{"key":"base$0$1$0","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","throwIfNamespace":true,"useBuiltIns":false}},{"key":"base$0$1$1","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$1","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$2","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$3","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$4","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$5","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$6","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]}},"options":{}},{"key":"base$0$0$7","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"base$0$0$8","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"base$0$0$9","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$10","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}}],"presets":[],"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/simiontomoiaga/git/server/packages/herteby:denormalize/migrations.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining","pipelineOperator","throwExpressions","dynamicImport","classProperties","classPrivateProperties","jsx",["flow",{}],"asyncGenerators","objectRestSpread","objectRestSpread",["flow",{}],"asyncGenerators"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"strictMode":false},"sourceFileName":"packages/herteby:denormalize/migrations.js","filename":"/Users/simiontomoiaga/git/server/packages/herteby:denormalize/migrations.js","passPerPreset":false,"envName":"development","cwd":"/Users/simiontomoiaga/git/server","root":"/Users/simiontomoiaga/git/server","generatorOpts":{"filename":"/Users/simiontomoiaga/git/server/packages/herteby:denormalize/migrations.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/herteby:denormalize/migrations.js"}},"code":"module.export({\n  MigrationHistory: () => MigrationHistory,\n  addMigration: () => addMigration,\n  migrate: () => migrate,\n  autoMigrate: () => autoMigrate\n});\n\nlet _;\n\nmodule.watch(require(\"lodash\"), {\n  default(v) {\n    _ = v;\n  }\n\n}, 0);\nlet Mongo;\nmodule.watch(require(\"meteor/mongo\"), {\n  Mongo(v) {\n    Mongo = v;\n  }\n\n}, 1);\nlet settings;\nmodule.watch(require(\"./cache.js\"), {\n  default(v) {\n    settings = v;\n  }\n\n}, 2);\nconst MigrationHistory = new Mongo.Collection('_cacheMigrations');\nlet migrations = [];\n\nfunction addMigration(collection, insertFn, options) {\n  let opts = _.clone(options);\n\n  if (opts.collection) {\n    //prevent Error: Converting circular structure to JSON\n    opts.collection = opts.collection._name;\n  }\n\n  opts = JSON.stringify(opts);\n  migrations.push({\n    options: opts,\n    collectionName: collection._name,\n    collection: collection,\n    cacheField: options.cacheField,\n    fn: insertFn\n  });\n}\n\nfunction migrate(collectionName, cacheField, selector) {\n  let migration = _.find(migrations, {\n    collectionName,\n    cacheField\n  });\n\n  if (!migration) {\n    throw new Error('no migration found for ' + collectionName + ' - ' + cacheField);\n  } else {\n    let time = new Date();\n    let n = 0;\n    migration.collection.find(selector || {}).forEach(doc => {\n      migration.fn(null, doc);\n      n++;\n    });\n    console.log(\"migrated \".concat(cacheField, \" of \").concat(n, \" docs in \").concat(collectionName + (selector ? ' matching ' + JSON.stringify(selector) : ''), \". It took \").concat(new Date() - time, \"ms\"));\n  }\n}\n\nfunction autoMigrate() {\n  _.each(migrations, migration => {\n    if (!MigrationHistory.findOne({\n      collectionName: migration.collectionName,\n      options: migration.options\n    })) {\n      migrate(migration.collectionName, migration.cacheField);\n      MigrationHistory.insert({\n        collectionName: migration.collectionName,\n        options: migration.options,\n        date: new Date()\n      });\n    }\n  });\n}","map":{"version":3,"sources":["packages/herteby:denormalize/migrations.js"],"names":["module","export","MigrationHistory","addMigration","migrate","autoMigrate","_","watch","require","default","v","Mongo","settings","Collection","migrations","collection","insertFn","options","opts","clone","_name","JSON","stringify","push","collectionName","cacheField","fn","selector","migration","find","Error","time","Date","n","forEach","doc","console","log","each","findOne","insert","date"],"mappings":"AAAAA,OAAOC,MAAP,CAAc;AAACC,oBAAiB,MAAIA,gBAAtB;AAAuCC,gBAAa,MAAIA,YAAxD;AAAqEC,WAAQ,MAAIA,OAAjF;AAAyFC,eAAY,MAAIA;AAAzG,CAAd;;AAAqI,IAAIC,CAAJ;;AAAMN,OAAOO,KAAP,CAAaC,QAAQ,QAAR,CAAb,EAA+B;AAACC,UAAQC,CAAR,EAAU;AAACJ,QAAEI,CAAF;AAAI;;AAAhB,CAA/B,EAAiD,CAAjD;AAAoD,IAAIC,KAAJ;AAAUX,OAAOO,KAAP,CAAaC,QAAQ,cAAR,CAAb,EAAqC;AAACG,QAAMD,CAAN,EAAQ;AAACC,YAAMD,CAAN;AAAQ;;AAAlB,CAArC,EAAyD,CAAzD;AAA4D,IAAIE,QAAJ;AAAaZ,OAAOO,KAAP,CAAaC,QAAQ,YAAR,CAAb,EAAmC;AAACC,UAAQC,CAAR,EAAU;AAACE,eAASF,CAAT;AAAW;;AAAvB,CAAnC,EAA4D,CAA5D;AAI3Q,MAAMR,mBAAmB,IAAIS,MAAME,UAAV,CAAqB,kBAArB,CAAzB;AAEP,IAAIC,aAAa,EAAjB;;AAEO,SAASX,YAAT,CAAsBY,UAAtB,EAAkCC,QAAlC,EAA4CC,OAA5C,EAAoD;AACzD,MAAIC,OAAOZ,EAAEa,KAAF,CAAQF,OAAR,CAAX;;AACA,MAAGC,KAAKH,UAAR,EAAmB;AAAE;AACnBG,SAAKH,UAAL,GAAkBG,KAAKH,UAAL,CAAgBK,KAAlC;AACD;;AACDF,SAAOG,KAAKC,SAAL,CAAeJ,IAAf,CAAP;AACAJ,aAAWS,IAAX,CAAgB;AACdN,aAAQC,IADM;AAEdM,oBAAeT,WAAWK,KAFZ;AAGdL,gBAAWA,UAHG;AAIdU,gBAAWR,QAAQQ,UAJL;AAKdC,QAAGV;AALW,GAAhB;AAOD;;AAEM,SAASZ,OAAT,CAAiBoB,cAAjB,EAAiCC,UAAjC,EAA6CE,QAA7C,EAAsD;AAC3D,MAAIC,YAAYtB,EAAEuB,IAAF,CAAOf,UAAP,EAAmB;AAACU,kBAAD;AAAiBC;AAAjB,GAAnB,CAAhB;;AACA,MAAG,CAACG,SAAJ,EAAc;AACZ,UAAM,IAAIE,KAAJ,CAAU,4BAA4BN,cAA5B,GAA6C,KAA7C,GAAqDC,UAA/D,CAAN;AACD,GAFD,MAEO;AACL,QAAIM,OAAO,IAAIC,IAAJ,EAAX;AACA,QAAIC,IAAI,CAAR;AACAL,cAAUb,UAAV,CAAqBc,IAArB,CAA0BF,YAAY,EAAtC,EAA0CO,OAA1C,CAAkDC,OAAO;AACvDP,gBAAUF,EAAV,CAAa,IAAb,EAAmBS,GAAnB;AACAF;AACD,KAHD;AAIAG,YAAQC,GAAR,oBAAwBZ,UAAxB,iBAAyCQ,CAAzC,sBAAsDT,kBAAkBG,WAAW,eAAeN,KAAKC,SAAL,CAAeK,QAAf,CAA1B,GAAqD,EAAvE,CAAtD,uBAA6I,IAAIK,IAAJ,KAAaD,IAA1J;AACD;AACF;;AAEM,SAAS1B,WAAT,GAAsB;AAC3BC,IAAEgC,IAAF,CAAOxB,UAAP,EAAmBc,aAAa;AAC9B,QAAG,CAAC1B,iBAAiBqC,OAAjB,CAAyB;AAACf,sBAAeI,UAAUJ,cAA1B;AAA0CP,eAAQW,UAAUX;AAA5D,KAAzB,CAAJ,EAAmG;AACjGb,cAAQwB,UAAUJ,cAAlB,EAAkCI,UAAUH,UAA5C;AACAvB,uBAAiBsC,MAAjB,CAAwB;AACtBhB,wBAAeI,UAAUJ,cADH;AAEtBP,iBAAQW,UAAUX,OAFI;AAGtBwB,cAAK,IAAIT,IAAJ;AAHiB,OAAxB;AAKD;AACF,GATD;AAUD","sourcesContent":["import _ from 'lodash'\nimport {Mongo} from 'meteor/mongo'\nimport settings from './cache.js'\n\nexport const MigrationHistory = new Mongo.Collection('_cacheMigrations')\n\nlet migrations = []\n\nexport function addMigration(collection, insertFn, options){\n  let opts = _.clone(options)\n  if(opts.collection){ //prevent Error: Converting circular structure to JSON\n    opts.collection = opts.collection._name\n  }\n  opts = JSON.stringify(opts)\n  migrations.push({\n    options:opts,\n    collectionName:collection._name,\n    collection:collection,\n    cacheField:options.cacheField,\n    fn:insertFn\n  })\n}\n\nexport function migrate(collectionName, cacheField, selector){\n  let migration = _.find(migrations, {collectionName, cacheField})\n  if(!migration){\n    throw new Error('no migration found for ' + collectionName + ' - ' + cacheField)\n  } else {\n    let time = new Date()\n    let n = 0\n    migration.collection.find(selector || {}).forEach(doc => {\n      migration.fn(null, doc)\n      n++\n    })\n    console.log(`migrated ${cacheField} of ${n} docs in ${collectionName + (selector ? ' matching ' + JSON.stringify(selector) : '')}. It took ${new Date() - time}ms`)\n  }\n}\n\nexport function autoMigrate(){\n  _.each(migrations, migration => {\n    if(!MigrationHistory.findOne({collectionName:migration.collectionName, options:migration.options})){\n      migrate(migration.collectionName, migration.cacheField)\n      MigrationHistory.insert({\n        collectionName:migration.collectionName,\n        options:migration.options,\n        date:new Date()\n      })\n    }    \n  })\n}"]},"sourceType":"script","hash":"a062c0c9960f0dd0b8595ece388a9be486869e95"}
