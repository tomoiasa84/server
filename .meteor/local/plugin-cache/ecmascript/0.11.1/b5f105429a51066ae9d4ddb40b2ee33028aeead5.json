{"metadata":{},"options":{"plugins":[{"key":"base$0$0","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"generateLetDeclarations":true,"enforceStrictMode":false}},{"key":"transform-meteor-dynamic-import","visitor":{"_exploded":{},"_verified":{},"CallExpression":{"enter":[null]}},"options":{}},{"key":"base$0$2","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"polyfill":false,"useBuiltIns":false}},{"key":"base$0$3","visitor":{"_exploded":{},"_verified":{},"PrivateName":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]}},"options":{"loose":true}},{"key":"base$0$4","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$5","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$6","visitor":{"Program":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"allowTopLevelThis":true,"strictMode":false,"loose":true}},{"key":"base$0$1$0","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","throwIfNamespace":true,"useBuiltIns":false}},{"key":"base$0$1$1","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$1","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$2","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$3","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$4","visitor":{"VariableDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"_exploded":true,"BlockStatement":{"enter":[null]},"SwitchStatement":{"enter":[null]},"Program":{"enter":[null]},"_verified":true,"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"base$0$0$5","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$6","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$7","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"base$0$0$8","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$9","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$10","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$11","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]}},"options":{}},{"key":"base$0$0$12","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$13","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$14","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$15","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$16","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]}},"options":{}},{"key":"base$0$0$17","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$18","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$19","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"base$0$0$20","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$21","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"base$0$0$22","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$23","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"regenerator-transform","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]}},"options":{}}],"presets":[],"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/simiontomoiaga/git/server/packages/reywood:publish-composite/lib/publication.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining","pipelineOperator","throwExpressions","dynamicImport","classProperties","classPrivateProperties","jsx",["flow",{}],"asyncGenerators","objectRestSpread","objectRestSpread",["flow",{}],"asyncGenerators"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"strictMode":false},"sourceFileName":"packages/reywood:publish-composite/lib/publication.js","filename":"/Users/simiontomoiaga/git/server/packages/reywood:publish-composite/lib/publication.js","passPerPreset":false,"envName":"development","cwd":"/Users/simiontomoiaga/git/server","root":"/Users/simiontomoiaga/git/server","generatorOpts":{"filename":"/Users/simiontomoiaga/git/server/packages/reywood:publish-composite/lib/publication.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/reywood:publish-composite/lib/publication.js"}},"code":"var Meteor;\nmodule.watch(require(\"meteor/meteor\"), {\n  Meteor: function (v) {\n    Meteor = v;\n  }\n}, 0);\nvar Match, check;\nmodule.watch(require(\"meteor/check\"), {\n  Match: function (v) {\n    Match = v;\n  },\n  check: function (v) {\n    check = v;\n  }\n}, 1);\n\nvar _;\n\nmodule.watch(require(\"meteor/underscore\"), {\n  _: function (v) {\n    _ = v;\n  }\n}, 2);\nvar debugLog;\nmodule.watch(require(\"./logging\"), {\n  debugLog: function (v) {\n    debugLog = v;\n  }\n}, 3);\nvar PublishedDocumentList;\nmodule.watch(require(\"./published_document_list\"), {\n  \"default\": function (v) {\n    PublishedDocumentList = v;\n  }\n}, 4);\n\nvar Publication =\n/*#__PURE__*/\nfunction () {\n  function Publication(subscription, options, args) {\n    check(options, {\n      find: Function,\n      children: Match.Optional([Object]),\n      collectionName: Match.Optional(String)\n    });\n    this.subscription = subscription;\n    this.options = options;\n    this.args = args || [];\n    this.childrenOptions = options.children || [];\n    this.publishedDocs = new PublishedDocumentList();\n    this.collectionName = options.collectionName;\n  }\n\n  var _proto = Publication.prototype;\n\n  _proto.publish = function () {\n    function publish() {\n      var _this = this;\n\n      this.cursor = this._getCursor();\n\n      if (!this.cursor) {\n        return;\n      }\n\n      var collectionName = this._getCollectionName(); // Use Meteor.bindEnvironment to make sure the callbacks are run with the same\n      // environmentVariables as when publishing the \"parent\".\n      // It's only needed when publish is being recursively run.\n\n\n      this.observeHandle = this.cursor.observe({\n        added: Meteor.bindEnvironment(function (doc) {\n          var alreadyPublished = _this.publishedDocs.has(doc._id);\n\n          if (alreadyPublished) {\n            debugLog('Publication.observeHandle.added', collectionName + \":\" + doc._id + \" already published\");\n\n            _this.publishedDocs.unflagForRemoval(doc._id);\n\n            _this._republishChildrenOf(doc);\n\n            _this.subscription.changed(collectionName, doc._id, doc);\n          } else {\n            _this.publishedDocs.add(collectionName, doc._id);\n\n            _this._publishChildrenOf(doc);\n\n            _this.subscription.added(collectionName, doc);\n          }\n        }),\n        changed: Meteor.bindEnvironment(function (newDoc) {\n          debugLog('Publication.observeHandle.changed', collectionName + \":\" + newDoc._id);\n\n          _this._republishChildrenOf(newDoc);\n        }),\n        removed: function (doc) {\n          debugLog('Publication.observeHandle.removed', collectionName + \":\" + doc._id);\n\n          _this._removeDoc(collectionName, doc._id);\n        }\n      });\n      this.observeChangesHandle = this.cursor.observeChanges({\n        changed: function (id, fields) {\n          debugLog('Publication.observeChangesHandle.changed', collectionName + \":\" + id);\n\n          _this.subscription.changed(collectionName, id, fields);\n        }\n      });\n    }\n\n    return publish;\n  }();\n\n  _proto.unpublish = function () {\n    function unpublish() {\n      debugLog('Publication.unpublish', this._getCollectionName());\n\n      this._stopObservingCursor();\n\n      this._unpublishAllDocuments();\n    }\n\n    return unpublish;\n  }();\n\n  _proto._republish = function () {\n    function _republish() {\n      this._stopObservingCursor();\n\n      this.publishedDocs.flagAllForRemoval();\n      debugLog('Publication._republish', 'run .publish again');\n      this.publish();\n      debugLog('Publication._republish', 'unpublish docs from old cursor');\n\n      this._removeFlaggedDocs();\n    }\n\n    return _republish;\n  }();\n\n  _proto._getCursor = function () {\n    function _getCursor() {\n      return this.options.find.apply(this.subscription.meteorSub, this.args);\n    }\n\n    return _getCursor;\n  }();\n\n  _proto._getCollectionName = function () {\n    function _getCollectionName() {\n      return this.collectionName || this.cursor && this.cursor._getCollectionName();\n    }\n\n    return _getCollectionName;\n  }();\n\n  _proto._publishChildrenOf = function () {\n    function _publishChildrenOf(doc) {\n      _.each(this.childrenOptions, function () {\n        function createChildPublication(options) {\n          var pub = new Publication(this.subscription, options, [doc].concat(this.args));\n          this.publishedDocs.addChildPub(doc._id, pub);\n          pub.publish();\n        }\n\n        return createChildPublication;\n      }(), this);\n    }\n\n    return _publishChildrenOf;\n  }();\n\n  _proto._republishChildrenOf = function () {\n    function _republishChildrenOf(doc) {\n      this.publishedDocs.eachChildPub(doc._id, function (publication) {\n        publication.args[0] = doc;\n\n        publication._republish();\n      });\n    }\n\n    return _republishChildrenOf;\n  }();\n\n  _proto._unpublishAllDocuments = function () {\n    function _unpublishAllDocuments() {\n      var _this2 = this;\n\n      this.publishedDocs.eachDocument(function (doc) {\n        _this2._removeDoc(doc.collectionName, doc.docId);\n      }, this);\n    }\n\n    return _unpublishAllDocuments;\n  }();\n\n  _proto._stopObservingCursor = function () {\n    function _stopObservingCursor() {\n      debugLog('Publication._stopObservingCursor', 'stop observing cursor');\n\n      if (this.observeHandle) {\n        this.observeHandle.stop();\n        delete this.observeHandle;\n      }\n\n      if (this.observeChangesHandle) {\n        this.observeChangesHandle.stop();\n        delete this.observeChangesHandle;\n      }\n    }\n\n    return _stopObservingCursor;\n  }();\n\n  _proto._removeFlaggedDocs = function () {\n    function _removeFlaggedDocs() {\n      var _this3 = this;\n\n      this.publishedDocs.eachDocument(function (doc) {\n        if (doc.isFlaggedForRemoval()) {\n          _this3._removeDoc(doc.collectionName, doc.docId);\n        }\n      }, this);\n    }\n\n    return _removeFlaggedDocs;\n  }();\n\n  _proto._removeDoc = function () {\n    function _removeDoc(collectionName, docId) {\n      this.subscription.removed(collectionName, docId);\n\n      this._unpublishChildrenOf(docId);\n\n      this.publishedDocs.remove(docId);\n    }\n\n    return _removeDoc;\n  }();\n\n  _proto._unpublishChildrenOf = function () {\n    function _unpublishChildrenOf(docId) {\n      debugLog('Publication._unpublishChildrenOf', \"unpublishing children of \" + this._getCollectionName() + \":\" + docId);\n      this.publishedDocs.eachChildPub(docId, function (publication) {\n        publication.unpublish();\n      });\n    }\n\n    return _unpublishChildrenOf;\n  }();\n\n  return Publication;\n}();\n\nmodule.exportDefault(Publication);","map":{"version":3,"sources":["packages/reywood:publish-composite/lib/publication.js"],"names":["Meteor","module","watch","require","v","Match","check","_","debugLog","PublishedDocumentList","Publication","subscription","options","args","find","Function","children","Optional","Object","collectionName","String","childrenOptions","publishedDocs","publish","cursor","_getCursor","_getCollectionName","observeHandle","observe","added","bindEnvironment","doc","alreadyPublished","has","_id","unflagForRemoval","_republishChildrenOf","changed","add","_publishChildrenOf","newDoc","removed","_removeDoc","observeChangesHandle","observeChanges","id","fields","unpublish","_stopObservingCursor","_unpublishAllDocuments","_republish","flagAllForRemoval","_removeFlaggedDocs","apply","meteorSub","each","createChildPublication","pub","concat","addChildPub","eachChildPub","publication","eachDocument","docId","stop","isFlaggedForRemoval","_unpublishChildrenOf","remove","exportDefault"],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { Match, check } from 'meteor/check';\nimport { _ } from 'meteor/underscore';\n\nimport { debugLog } from './logging';\nimport PublishedDocumentList from './published_document_list';\n\n\nclass Publication {\n    constructor(subscription, options, args) {\n        check(options, {\n            find: Function,\n            children: Match.Optional([Object]),\n            collectionName: Match.Optional(String),\n        });\n\n        this.subscription = subscription;\n        this.options = options;\n        this.args = args || [];\n        this.childrenOptions = options.children || [];\n        this.publishedDocs = new PublishedDocumentList();\n        this.collectionName = options.collectionName;\n    }\n\n    publish() {\n        this.cursor = this._getCursor();\n        if (!this.cursor) { return; }\n\n        const collectionName = this._getCollectionName();\n\n        // Use Meteor.bindEnvironment to make sure the callbacks are run with the same\n        // environmentVariables as when publishing the \"parent\".\n        // It's only needed when publish is being recursively run.\n        this.observeHandle = this.cursor.observe({\n            added: Meteor.bindEnvironment((doc) => {\n                const alreadyPublished = this.publishedDocs.has(doc._id);\n\n                if (alreadyPublished) {\n                    debugLog('Publication.observeHandle.added', `${collectionName}:${doc._id} already published`);\n                    this.publishedDocs.unflagForRemoval(doc._id);\n                    this._republishChildrenOf(doc);\n                    this.subscription.changed(collectionName, doc._id, doc);\n                } else {\n                    this.publishedDocs.add(collectionName, doc._id);\n                    this._publishChildrenOf(doc);\n                    this.subscription.added(collectionName, doc);\n                }\n            }),\n            changed: Meteor.bindEnvironment((newDoc) => {\n                debugLog('Publication.observeHandle.changed', `${collectionName}:${newDoc._id}`);\n                this._republishChildrenOf(newDoc);\n            }),\n            removed: (doc) => {\n                debugLog('Publication.observeHandle.removed', `${collectionName}:${doc._id}`);\n                this._removeDoc(collectionName, doc._id);\n            },\n        });\n\n        this.observeChangesHandle = this.cursor.observeChanges({\n            changed: (id, fields) => {\n                debugLog('Publication.observeChangesHandle.changed', `${collectionName}:${id}`);\n                this.subscription.changed(collectionName, id, fields);\n            },\n        });\n    }\n\n    unpublish() {\n        debugLog('Publication.unpublish', this._getCollectionName());\n        this._stopObservingCursor();\n        this._unpublishAllDocuments();\n    }\n\n    _republish() {\n        this._stopObservingCursor();\n\n        this.publishedDocs.flagAllForRemoval();\n\n        debugLog('Publication._republish', 'run .publish again');\n        this.publish();\n\n        debugLog('Publication._republish', 'unpublish docs from old cursor');\n        this._removeFlaggedDocs();\n    }\n\n    _getCursor() {\n        return this.options.find.apply(this.subscription.meteorSub, this.args);\n    }\n\n    _getCollectionName() {\n        return this.collectionName || (this.cursor && this.cursor._getCollectionName());\n    }\n\n    _publishChildrenOf(doc) {\n        _.each(this.childrenOptions, function createChildPublication(options) {\n            const pub = new Publication(this.subscription, options, [doc].concat(this.args));\n            this.publishedDocs.addChildPub(doc._id, pub);\n            pub.publish();\n        }, this);\n    }\n\n    _republishChildrenOf(doc) {\n        this.publishedDocs.eachChildPub(doc._id, (publication) => {\n            publication.args[0] = doc;\n            publication._republish();\n        });\n    }\n\n    _unpublishAllDocuments() {\n        this.publishedDocs.eachDocument((doc) => {\n            this._removeDoc(doc.collectionName, doc.docId);\n        }, this);\n    }\n\n    _stopObservingCursor() {\n        debugLog('Publication._stopObservingCursor', 'stop observing cursor');\n\n        if (this.observeHandle) {\n            this.observeHandle.stop();\n            delete this.observeHandle;\n        }\n\n        if (this.observeChangesHandle) {\n            this.observeChangesHandle.stop();\n            delete this.observeChangesHandle;\n        }\n    }\n\n    _removeFlaggedDocs() {\n        this.publishedDocs.eachDocument((doc) => {\n            if (doc.isFlaggedForRemoval()) {\n                this._removeDoc(doc.collectionName, doc.docId);\n            }\n        }, this);\n    }\n\n    _removeDoc(collectionName, docId) {\n        this.subscription.removed(collectionName, docId);\n        this._unpublishChildrenOf(docId);\n        this.publishedDocs.remove(docId);\n    }\n\n    _unpublishChildrenOf(docId) {\n        debugLog('Publication._unpublishChildrenOf', `unpublishing children of ${this._getCollectionName()}:${docId}`);\n\n        this.publishedDocs.eachChildPub(docId, (publication) => {\n            publication.unpublish();\n        });\n    }\n}\n\nexport default Publication;\n"]},"sourceType":"script","hash":"b5f105429a51066ae9d4ddb40b2ee33028aeead5"}
