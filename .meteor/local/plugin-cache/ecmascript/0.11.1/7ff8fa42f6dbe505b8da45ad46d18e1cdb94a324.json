{"metadata":{},"options":{"plugins":[{"key":"base$0$0","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"generateLetDeclarations":true,"enforceStrictMode":false}},{"key":"transform-meteor-dynamic-import","visitor":{"_exploded":{},"_verified":{},"CallExpression":{"enter":[null]}},"options":{}},{"key":"base$0$2","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"polyfill":false,"useBuiltIns":false}},{"key":"base$0$3","visitor":{"_exploded":{},"_verified":{},"PrivateName":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]}},"options":{"loose":true}},{"key":"base$0$4","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$5","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$6","visitor":{"Program":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"allowTopLevelThis":true,"strictMode":false,"loose":true}},{"key":"base$0$1$0","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","throwIfNamespace":true,"useBuiltIns":false}},{"key":"base$0$1$1","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$1","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$2","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$3","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$4","visitor":{"VariableDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"_exploded":true,"BlockStatement":{"enter":[null]},"SwitchStatement":{"enter":[null]},"Program":{"enter":[null]},"_verified":true,"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"base$0$0$5","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$6","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$7","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"base$0$0$8","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$9","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$10","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$11","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]}},"options":{}},{"key":"base$0$0$12","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$13","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$14","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$15","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"base$0$0$16","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]}},"options":{}},{"key":"base$0$0$17","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$18","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$19","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"base$0$0$20","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$21","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"base$0$0$22","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0$23","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"regenerator-transform","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]}},"options":{}}],"presets":[],"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/simiontomoiaga/git/server/packages/reywood:publish-composite/lib/subscription.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining","pipelineOperator","throwExpressions","dynamicImport","classProperties","classPrivateProperties","jsx",["flow",{}],"asyncGenerators","objectRestSpread","objectRestSpread",["flow",{}],"asyncGenerators"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"strictMode":false},"sourceFileName":"packages/reywood:publish-composite/lib/subscription.js","filename":"/Users/simiontomoiaga/git/server/packages/reywood:publish-composite/lib/subscription.js","passPerPreset":false,"envName":"development","cwd":"/Users/simiontomoiaga/git/server","root":"/Users/simiontomoiaga/git/server","generatorOpts":{"filename":"/Users/simiontomoiaga/git/server/packages/reywood:publish-composite/lib/subscription.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/reywood:publish-composite/lib/subscription.js"}},"code":"var _;\n\nmodule.watch(require(\"meteor/underscore\"), {\n  _: function (v) {\n    _ = v;\n  }\n}, 0);\nvar DocumentRefCounter;\nmodule.watch(require(\"./doc_ref_counter\"), {\n  \"default\": function (v) {\n    DocumentRefCounter = v;\n  }\n}, 1);\nvar debugLog;\nmodule.watch(require(\"./logging\"), {\n  debugLog: function (v) {\n    debugLog = v;\n  }\n}, 2);\n\nvar Subscription =\n/*#__PURE__*/\nfunction () {\n  function Subscription(meteorSub) {\n    var _this = this;\n\n    this.meteorSub = meteorSub;\n    this.docHash = {};\n    this.refCounter = new DocumentRefCounter({\n      onChange: function (collectionName, docId, refCount) {\n        debugLog('Subscription.refCounter.onChange', collectionName + \":\" + docId.valueOf() + \" \" + refCount);\n\n        if (refCount <= 0) {\n          meteorSub.removed(collectionName, docId);\n\n          _this._removeDocHash(collectionName, docId);\n        }\n      }\n    });\n  }\n\n  var _proto = Subscription.prototype;\n\n  _proto.added = function () {\n    function added(collectionName, doc) {\n      this.refCounter.increment(collectionName, doc._id);\n\n      if (this._hasDocChanged(collectionName, doc._id, doc)) {\n        debugLog('Subscription.added', collectionName + \":\" + doc._id);\n        this.meteorSub.added(collectionName, doc._id, doc);\n\n        this._addDocHash(collectionName, doc);\n      }\n    }\n\n    return added;\n  }();\n\n  _proto.changed = function () {\n    function changed(collectionName, id, changes) {\n      if (this._shouldSendChanges(collectionName, id, changes)) {\n        debugLog('Subscription.changed', collectionName + \":\" + id);\n        this.meteorSub.changed(collectionName, id, changes);\n\n        this._updateDocHash(collectionName, id, changes);\n      }\n    }\n\n    return changed;\n  }();\n\n  _proto.removed = function () {\n    function removed(collectionName, id) {\n      debugLog('Subscription.removed', collectionName + \":\" + id.valueOf());\n      this.refCounter.decrement(collectionName, id);\n    }\n\n    return removed;\n  }();\n\n  _proto._addDocHash = function () {\n    function _addDocHash(collectionName, doc) {\n      this.docHash[buildHashKey(collectionName, doc._id)] = doc;\n    }\n\n    return _addDocHash;\n  }();\n\n  _proto._updateDocHash = function () {\n    function _updateDocHash(collectionName, id, changes) {\n      var key = buildHashKey(collectionName, id);\n      var existingDoc = this.docHash[key] || {};\n      this.docHash[key] = _.extend(existingDoc, changes);\n    }\n\n    return _updateDocHash;\n  }();\n\n  _proto._shouldSendChanges = function () {\n    function _shouldSendChanges(collectionName, id, changes) {\n      return this._isDocPublished(collectionName, id) && this._hasDocChanged(collectionName, id, changes);\n    }\n\n    return _shouldSendChanges;\n  }();\n\n  _proto._isDocPublished = function () {\n    function _isDocPublished(collectionName, id) {\n      var key = buildHashKey(collectionName, id);\n      return !!this.docHash[key];\n    }\n\n    return _isDocPublished;\n  }();\n\n  _proto._hasDocChanged = function () {\n    function _hasDocChanged(collectionName, id, doc) {\n      var existingDoc = this.docHash[buildHashKey(collectionName, id)];\n\n      if (!existingDoc) {\n        return true;\n      }\n\n      return _.any(_.keys(doc), function (key) {\n        return !_.isEqual(doc[key], existingDoc[key]);\n      });\n    }\n\n    return _hasDocChanged;\n  }();\n\n  _proto._removeDocHash = function () {\n    function _removeDocHash(collectionName, id) {\n      var key = buildHashKey(collectionName, id);\n      delete this.docHash[key];\n    }\n\n    return _removeDocHash;\n  }();\n\n  return Subscription;\n}();\n\nfunction buildHashKey(collectionName, id) {\n  return collectionName + \"::\" + id.valueOf();\n}\n\nmodule.exportDefault(Subscription);","map":{"version":3,"sources":["packages/reywood:publish-composite/lib/subscription.js"],"names":["_","module","watch","require","v","DocumentRefCounter","debugLog","Subscription","meteorSub","docHash","refCounter","onChange","collectionName","docId","refCount","valueOf","removed","_removeDocHash","added","doc","increment","_id","_hasDocChanged","_addDocHash","changed","id","changes","_shouldSendChanges","_updateDocHash","decrement","buildHashKey","key","existingDoc","extend","_isDocPublished","any","keys","isEqual","exportDefault"],"mappings":"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","sourcesContent":["import { _ } from 'meteor/underscore';\n\nimport DocumentRefCounter from './doc_ref_counter';\nimport { debugLog } from './logging';\n\n\nclass Subscription {\n    constructor(meteorSub) {\n        this.meteorSub = meteorSub;\n        this.docHash = {};\n        this.refCounter = new DocumentRefCounter({\n            onChange: (collectionName, docId, refCount) => {\n                debugLog('Subscription.refCounter.onChange', `${collectionName}:${docId.valueOf()} ${refCount}`);\n                if (refCount <= 0) {\n                    meteorSub.removed(collectionName, docId);\n                    this._removeDocHash(collectionName, docId);\n                }\n            },\n        });\n    }\n\n    added(collectionName, doc) {\n        this.refCounter.increment(collectionName, doc._id);\n\n        if (this._hasDocChanged(collectionName, doc._id, doc)) {\n            debugLog('Subscription.added', `${collectionName}:${doc._id}`);\n            this.meteorSub.added(collectionName, doc._id, doc);\n            this._addDocHash(collectionName, doc);\n        }\n    }\n\n    changed(collectionName, id, changes) {\n        if (this._shouldSendChanges(collectionName, id, changes)) {\n            debugLog('Subscription.changed', `${collectionName}:${id}`);\n            this.meteorSub.changed(collectionName, id, changes);\n            this._updateDocHash(collectionName, id, changes);\n        }\n    }\n\n    removed(collectionName, id) {\n        debugLog('Subscription.removed', `${collectionName}:${id.valueOf()}`);\n        this.refCounter.decrement(collectionName, id);\n    }\n\n    _addDocHash(collectionName, doc) {\n        this.docHash[buildHashKey(collectionName, doc._id)] = doc;\n    }\n\n    _updateDocHash(collectionName, id, changes) {\n        const key = buildHashKey(collectionName, id);\n        const existingDoc = this.docHash[key] || {};\n        this.docHash[key] = _.extend(existingDoc, changes);\n    }\n\n    _shouldSendChanges(collectionName, id, changes) {\n        return this._isDocPublished(collectionName, id) &&\n            this._hasDocChanged(collectionName, id, changes);\n    }\n\n    _isDocPublished(collectionName, id) {\n        const key = buildHashKey(collectionName, id);\n        return !!this.docHash[key];\n    }\n\n    _hasDocChanged(collectionName, id, doc) {\n        const existingDoc = this.docHash[buildHashKey(collectionName, id)];\n\n        if (!existingDoc) { return true; }\n\n        return _.any(_.keys(doc), key => !_.isEqual(doc[key], existingDoc[key]));\n    }\n\n    _removeDocHash(collectionName, id) {\n        const key = buildHashKey(collectionName, id);\n        delete this.docHash[key];\n    }\n}\n\nfunction buildHashKey(collectionName, id) {\n    return `${collectionName}::${id.valueOf()}`;\n}\n\nexport default Subscription;\n"]},"sourceType":"script","hash":"7ff8fa42f6dbe505b8da45ad46d18e1cdb94a324"}
