{"metadata":{},"options":{"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/simiontomoiaga/git/server/packages/cultofcoders:apollo/server/initialize.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","jsx",["flow",{}],["flow",{}],"objectRestSpread","objectRestSpread","dynamicImport","asyncGenerators","classProperties","classPrivateProperties"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.x86_64"},"sourceFileName":"packages/cultofcoders:apollo/server/initialize.js","filename":"/Users/simiontomoiaga/git/server/packages/cultofcoders:apollo/server/initialize.js","passPerPreset":false,"envName":"development","cwd":"/Users/simiontomoiaga/git/server","root":"/Users/simiontomoiaga/git/server","plugins":[{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"generateLetDeclarations":true,"enforceStrictMode":false}},{"key":"syntax-flow","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"transform-flow-strip-types","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"ClassPrivateProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"transform-runtime","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"transform-meteor-dynamic-import","visitor":{"_exploded":{},"_verified":{},"CallExpression":{"enter":[null]}},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"transform-modules-commonjs","visitor":{"Program":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"allowTopLevelThis":true,"strictMode":false,"loose":true}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]}},"options":{"loose":true}}],"presets":[],"generatorOpts":{"filename":"/Users/simiontomoiaga/git/server/packages/cultofcoders:apollo/server/initialize.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/cultofcoders:apollo/server/initialize.js"}},"code":"var _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nvar _objectSpread2 = _interopRequireDefault(require(\"@babel/runtime/helpers/objectSpread\"));\n\nmodule.export({\n  default: () => initialize\n});\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\nlet db;\nmodule.link(\"meteor/cultofcoders:grapher\", {\n  db(v) {\n    db = v;\n  }\n\n}, 1);\nlet WebApp;\nmodule.link(\"meteor/webapp\", {\n  WebApp(v) {\n    WebApp = v;\n  }\n\n}, 2);\nlet ApolloServer;\nmodule.link(\"apollo-server-express\", {\n  ApolloServer(v) {\n    ApolloServer = v;\n  }\n\n}, 3);\nlet getSchema;\nmodule.link(\"graphql-load\", {\n  getSchema(v) {\n    getSchema = v;\n  }\n\n}, 4);\nlet AUTH_TOKEN_KEY;\nmodule.link(\"../constants\", {\n  AUTH_TOKEN_KEY(v) {\n    AUTH_TOKEN_KEY = v;\n  }\n\n}, 5);\nlet defaultSchemaDirectives;\nmodule.link(\"./directives\", {\n  default(v) {\n    defaultSchemaDirectives = v;\n  }\n\n}, 6);\nlet getUserForContext;\nmodule.link(\"./core/users\", {\n  getUserForContext(v) {\n    getUserForContext = v;\n  }\n\n}, 7);\n\nfunction initialize(apolloConfig = {}, meteorApolloConfig = {}) {\n  meteorApolloConfig = Object.assign({\n    gui: Meteor.isDevelopment,\n    middlewares: [],\n    userFields: {\n      _id: 1,\n      roles: 1,\n      username: 1,\n      emails: 1\n    }\n  }, meteorApolloConfig);\n  const {\n    typeDefs,\n    resolvers\n  } = getSchema();\n  const initialApolloConfig = Object.assign({}, apolloConfig);\n  apolloConfig = (0, _objectSpread2.default)({\n    introspection: Meteor.isDevelopment,\n    debug: Meteor.isDevelopment,\n    path: '/graphql',\n    formatError: e => {\n      console.error(e);\n      return {\n        message: e.message,\n        locations: e.locations,\n        path: e.path\n      };\n    }\n  }, initialApolloConfig, {\n    typeDefs,\n    resolvers,\n    schemaDirectives: (0, _objectSpread2.default)({}, defaultSchemaDirectives, initialApolloConfig.schemaDirectives ? initialApolloConfig.schemaDirectives : []),\n    context: getContextCreator(meteorApolloConfig, initialApolloConfig.context),\n    subscriptions: getSubscriptionConfig(meteorApolloConfig)\n  });\n  const server = new ApolloServer(apolloConfig);\n  server.applyMiddleware({\n    app: WebApp.connectHandlers,\n    gui: meteorApolloConfig.gui\n  });\n  server.installSubscriptionHandlers(WebApp.httpServer);\n  meteorApolloConfig.middlewares.forEach(middleware => {\n    WebApp.connectHandlers.use('/graphql', middleware);\n  }); // We are doing this work-around because Playground sets headers and WebApp also sets headers\n  // Resulting into a conflict and a server side exception of \"Headers already sent\"\n\n  WebApp.connectHandlers.use('/graphql', (req, res) => {\n    if (req.method === 'GET') {\n      res.end();\n    }\n  });\n  return {\n    server\n  };\n}\n\nfunction getContextCreator(meteorApolloConfig, defaultContextResolver) {\n  return function getContext({\n    req,\n    connection\n  }) {\n    return Promise.asyncApply(() => {\n      const defaultContext = defaultContextResolver ? Promise.await(defaultContextResolver({\n        req,\n        connection\n      })) : {};\n      Object.assign(defaultContext, {\n        db\n      });\n\n      if (connection) {\n        return (0, _objectSpread2.default)({}, defaultContext, connection.context);\n      } else {\n        let userContext = {};\n\n        if (Package['accounts-base']) {\n          const loginToken = req.headers['meteor-login-token'] || req.cookies['meteor-login-token'];\n          userContext = Promise.await(getUserForContext(loginToken, meteorApolloConfig.userFields));\n        }\n\n        return (0, _objectSpread2.default)({}, defaultContext, userContext);\n      }\n    });\n  };\n}\n\nfunction getSubscriptionConfig(meteorApolloConfig) {\n  return {\n    onConnect: (connectionParams, webSocket, context) => Promise.asyncApply(() => {\n      const loginToken = connectionParams[AUTH_TOKEN_KEY];\n      return new Promise((resolve, reject) => {\n        if (loginToken) {\n          const userContext = getUserForContext(loginToken, meteorApolloConfig.userFields).then(userContext => {\n            resolve(userContext);\n          });\n        } else {\n          resolve({});\n        }\n      });\n    })\n  };\n}","map":{"version":3,"sources":["packages/cultofcoders:apollo/server/initialize.js"],"names":["module","export","default","initialize","Meteor","link","v","db","WebApp","ApolloServer","getSchema","AUTH_TOKEN_KEY","defaultSchemaDirectives","getUserForContext","apolloConfig","meteorApolloConfig","Object","assign","gui","isDevelopment","middlewares","userFields","_id","roles","username","emails","typeDefs","resolvers","initialApolloConfig","introspection","debug","path","formatError","e","console","error","message","locations","schemaDirectives","context","getContextCreator","subscriptions","getSubscriptionConfig","server","applyMiddleware","app","connectHandlers","installSubscriptionHandlers","httpServer","forEach","middleware","use","req","res","method","end","defaultContextResolver","getContext","connection","defaultContext","userContext","Package","loginToken","headers","cookies","onConnect","connectionParams","webSocket","Promise","resolve","reject","then"],"mappings":";;;;AAAAA,MAAM,CAACC,MAAP,CAAc;AAACC,EAAAA,OAAO,EAAC,MAAIC;AAAb,CAAd;AAAwC,IAAIC,MAAJ;AAAWJ,MAAM,CAACK,IAAP,CAAY,eAAZ,EAA4B;AAACD,EAAAA,MAAM,CAACE,CAAD,EAAG;AAACF,IAAAA,MAAM,GAACE,CAAP;AAAS;;AAApB,CAA5B,EAAkD,CAAlD;AAAqD,IAAIC,EAAJ;AAAOP,MAAM,CAACK,IAAP,CAAY,6BAAZ,EAA0C;AAACE,EAAAA,EAAE,CAACD,CAAD,EAAG;AAACC,IAAAA,EAAE,GAACD,CAAH;AAAK;;AAAZ,CAA1C,EAAwD,CAAxD;AAA2D,IAAIE,MAAJ;AAAWR,MAAM,CAACK,IAAP,CAAY,eAAZ,EAA4B;AAACG,EAAAA,MAAM,CAACF,CAAD,EAAG;AAACE,IAAAA,MAAM,GAACF,CAAP;AAAS;;AAApB,CAA5B,EAAkD,CAAlD;AAAqD,IAAIG,YAAJ;AAAiBT,MAAM,CAACK,IAAP,CAAY,uBAAZ,EAAoC;AAACI,EAAAA,YAAY,CAACH,CAAD,EAAG;AAACG,IAAAA,YAAY,GAACH,CAAb;AAAe;;AAAhC,CAApC,EAAsE,CAAtE;AAAyE,IAAII,SAAJ;AAAcV,MAAM,CAACK,IAAP,CAAY,cAAZ,EAA2B;AAACK,EAAAA,SAAS,CAACJ,CAAD,EAAG;AAACI,IAAAA,SAAS,GAACJ,CAAV;AAAY;;AAA1B,CAA3B,EAAuD,CAAvD;AAA0D,IAAIK,cAAJ;AAAmBX,MAAM,CAACK,IAAP,CAAY,cAAZ,EAA2B;AAACM,EAAAA,cAAc,CAACL,CAAD,EAAG;AAACK,IAAAA,cAAc,GAACL,CAAf;AAAiB;;AAApC,CAA3B,EAAiE,CAAjE;AAAoE,IAAIM,uBAAJ;AAA4BZ,MAAM,CAACK,IAAP,CAAY,cAAZ,EAA2B;AAACH,EAAAA,OAAO,CAACI,CAAD,EAAG;AAACM,IAAAA,uBAAuB,GAACN,CAAxB;AAA0B;;AAAtC,CAA3B,EAAmE,CAAnE;AAAsE,IAAIO,iBAAJ;AAAsBb,MAAM,CAACK,IAAP,CAAY,cAAZ,EAA2B;AAACQ,EAAAA,iBAAiB,CAACP,CAAD,EAAG;AAACO,IAAAA,iBAAiB,GAACP,CAAlB;AAAoB;;AAA1C,CAA3B,EAAuE,CAAvE;;AAc5kB,SAASH,UAAT,CAAoBW,YAAY,GAAG,EAAnC,EAAuCC,kBAAkB,GAAG,EAA5D,EAAgE;AAC7EA,EAAAA,kBAAkB,GAAGC,MAAM,CAACC,MAAP,CACnB;AACEC,IAAAA,GAAG,EAAEd,MAAM,CAACe,aADd;AAEEC,IAAAA,WAAW,EAAE,EAFf;AAGEC,IAAAA,UAAU,EAAE;AACVC,MAAAA,GAAG,EAAE,CADK;AAEVC,MAAAA,KAAK,EAAE,CAFG;AAGVC,MAAAA,QAAQ,EAAE,CAHA;AAIVC,MAAAA,MAAM,EAAE;AAJE;AAHd,GADmB,EAWnBV,kBAXmB,CAArB;AAcA,QAAM;AAAEW,IAAAA,QAAF;AAAYC,IAAAA;AAAZ,MAA0BjB,SAAS,EAAzC;AAEA,QAAMkB,mBAAmB,GAAGZ,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkBH,YAAlB,CAA5B;AACAA,EAAAA,YAAY;AACVe,IAAAA,aAAa,EAAEzB,MAAM,CAACe,aADZ;AAEVW,IAAAA,KAAK,EAAE1B,MAAM,CAACe,aAFJ;AAGVY,IAAAA,IAAI,EAAE,UAHI;AAIVC,IAAAA,WAAW,EAAEC,CAAC,IAAI;AAChBC,MAAAA,OAAO,CAACC,KAAR,CAAcF,CAAd;AAEA,aAAO;AACLG,QAAAA,OAAO,EAAEH,CAAC,CAACG,OADN;AAELC,QAAAA,SAAS,EAAEJ,CAAC,CAACI,SAFR;AAGLN,QAAAA,IAAI,EAAEE,CAAC,CAACF;AAHH,OAAP;AAKD;AAZS,KAaPH,mBAbO;AAcVF,IAAAA,QAdU;AAeVC,IAAAA,SAfU;AAgBVW,IAAAA,gBAAgB,kCACX1B,uBADW,EAEVgB,mBAAmB,CAACU,gBAApB,GACAV,mBAAmB,CAACU,gBADpB,GAEA,EAJU,CAhBN;AAsBVC,IAAAA,OAAO,EAAEC,iBAAiB,CAACzB,kBAAD,EAAqBa,mBAAmB,CAACW,OAAzC,CAtBhB;AAuBVE,IAAAA,aAAa,EAAEC,qBAAqB,CAAC3B,kBAAD;AAvB1B,IAAZ;AA0BA,QAAM4B,MAAM,GAAG,IAAIlC,YAAJ,CAAiBK,YAAjB,CAAf;AAEA6B,EAAAA,MAAM,CAACC,eAAP,CAAuB;AACrBC,IAAAA,GAAG,EAAErC,MAAM,CAACsC,eADS;AAErB5B,IAAAA,GAAG,EAAEH,kBAAkB,CAACG;AAFH,GAAvB;AAKAyB,EAAAA,MAAM,CAACI,2BAAP,CAAmCvC,MAAM,CAACwC,UAA1C;AAEAjC,EAAAA,kBAAkB,CAACK,WAAnB,CAA+B6B,OAA/B,CAAuCC,UAAU,IAAI;AACnD1C,IAAAA,MAAM,CAACsC,eAAP,CAAuBK,GAAvB,CAA2B,UAA3B,EAAuCD,UAAvC;AACD,GAFD,EArD6E,CAyD7E;AACA;;AACA1C,EAAAA,MAAM,CAACsC,eAAP,CAAuBK,GAAvB,CAA2B,UAA3B,EAAuC,CAACC,GAAD,EAAMC,GAAN,KAAc;AACnD,QAAID,GAAG,CAACE,MAAJ,KAAe,KAAnB,EAA0B;AACxBD,MAAAA,GAAG,CAACE,GAAJ;AACD;AACF,GAJD;AAMA,SAAO;AACLZ,IAAAA;AADK,GAAP;AAGD;;AAED,SAASH,iBAAT,CAA2BzB,kBAA3B,EAA+CyC,sBAA/C,EAAuE;AACrE,SAAO,SAAeC,UAAf,CAA0B;AAAEL,IAAAA,GAAF;AAAOM,IAAAA;AAAP,GAA1B;AAAA,oCAA+C;AACpD,YAAMC,cAAc,GAAGH,sBAAsB,iBACnCA,sBAAsB,CAAC;AAAEJ,QAAAA,GAAF;AAAOM,QAAAA;AAAP,OAAD,CADa,IAEzC,EAFJ;AAIA1C,MAAAA,MAAM,CAACC,MAAP,CAAc0C,cAAd,EAA8B;AAAEpD,QAAAA;AAAF,OAA9B;;AAEA,UAAImD,UAAJ,EAAgB;AACd,+CACKC,cADL,EAEKD,UAAU,CAACnB,OAFhB;AAID,OALD,MAKO;AACL,YAAIqB,WAAW,GAAG,EAAlB;;AACA,YAAIC,OAAO,CAAC,eAAD,CAAX,EAA8B;AAC5B,gBAAMC,UAAU,GACdV,GAAG,CAACW,OAAJ,CAAY,oBAAZ,KAAqCX,GAAG,CAACY,OAAJ,CAAY,oBAAZ,CADvC;AAEAJ,UAAAA,WAAW,iBAAS/C,iBAAiB,CAACiD,UAAD,EAAa/C,kBAAkB,CAACM,UAAhC,CAA1B,CAAX;AACD;;AAED,+CACKsC,cADL,EAEKC,WAFL;AAID;AACF,KAzBM;AAAA,GAAP;AA0BD;;AAED,SAASlB,qBAAT,CAA+B3B,kBAA/B,EAAmD;AACjD,SAAO;AACLkD,IAAAA,SAAS,EAAE,CAAOC,gBAAP,EAAyBC,SAAzB,EAAoC5B,OAApC,8BAAgD;AACzD,YAAMuB,UAAU,GAAGI,gBAAgB,CAACvD,cAAD,CAAnC;AAEA,aAAO,IAAIyD,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AACtC,YAAIR,UAAJ,EAAgB;AACd,gBAAMF,WAAW,GAAG/C,iBAAiB,CACnCiD,UADmC,EAEnC/C,kBAAkB,CAACM,UAFgB,CAAjB,CAGlBkD,IAHkB,CAGbX,WAAW,IAAI;AACpBS,YAAAA,OAAO,CAACT,WAAD,CAAP;AACD,WALmB,CAApB;AAMD,SAPD,MAOO;AACLS,UAAAA,OAAO,CAAC,EAAD,CAAP;AACD;AACF,OAXM,CAAP;AAYD,KAfU;AADN,GAAP;AAkBD","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { db } from 'meteor/cultofcoders:grapher';\nimport { WebApp } from 'meteor/webapp';\nimport { ApolloServer } from 'apollo-server-express';\nimport { getSchema } from 'graphql-load';\nimport { AUTH_TOKEN_KEY } from '../constants';\nimport defaultSchemaDirectives from './directives';\nimport { getUserForContext } from './core/users';\n\n/**\n *\n * @param {*} apolloConfig Options https://www.apollographql.com/docs/apollo-server/api/apollo-server.html#constructor-options-lt-ApolloServer-gt\n * @param {MeteorApolloConfig} meteorApolloConfig\n */\nexport default function initialize(apolloConfig = {}, meteorApolloConfig = {}) {\n  meteorApolloConfig = Object.assign(\n    {\n      gui: Meteor.isDevelopment,\n      middlewares: [],\n      userFields: {\n        _id: 1,\n        roles: 1,\n        username: 1,\n        emails: 1,\n      },\n    },\n    meteorApolloConfig\n  );\n\n  const { typeDefs, resolvers } = getSchema();\n\n  const initialApolloConfig = Object.assign({}, apolloConfig);\n  apolloConfig = {\n    introspection: Meteor.isDevelopment,\n    debug: Meteor.isDevelopment,\n    path: '/graphql',\n    formatError: e => {\n      console.error(e);\n\n      return {\n        message: e.message,\n        locations: e.locations,\n        path: e.path,\n      };\n    },\n    ...initialApolloConfig,\n    typeDefs,\n    resolvers,\n    schemaDirectives: {\n      ...defaultSchemaDirectives,\n      ...(initialApolloConfig.schemaDirectives\n        ? initialApolloConfig.schemaDirectives\n        : []),\n    },\n    context: getContextCreator(meteorApolloConfig, initialApolloConfig.context),\n    subscriptions: getSubscriptionConfig(meteorApolloConfig),\n  };\n\n  const server = new ApolloServer(apolloConfig);\n\n  server.applyMiddleware({\n    app: WebApp.connectHandlers,\n    gui: meteorApolloConfig.gui,\n  });\n\n  server.installSubscriptionHandlers(WebApp.httpServer);\n\n  meteorApolloConfig.middlewares.forEach(middleware => {\n    WebApp.connectHandlers.use('/graphql', middleware);\n  });\n\n  // We are doing this work-around because Playground sets headers and WebApp also sets headers\n  // Resulting into a conflict and a server side exception of \"Headers already sent\"\n  WebApp.connectHandlers.use('/graphql', (req, res) => {\n    if (req.method === 'GET') {\n      res.end();\n    }\n  });\n\n  return {\n    server,\n  };\n}\n\nfunction getContextCreator(meteorApolloConfig, defaultContextResolver) {\n  return async function getContext({ req, connection }) {\n    const defaultContext = defaultContextResolver\n      ? await defaultContextResolver({ req, connection })\n      : {};\n\n    Object.assign(defaultContext, { db });\n\n    if (connection) {\n      return {\n        ...defaultContext,\n        ...connection.context,\n      };\n    } else {\n      let userContext = {};\n      if (Package['accounts-base']) {\n        const loginToken =\n          req.headers['meteor-login-token'] || req.cookies['meteor-login-token'];\n        userContext = await getUserForContext(loginToken, meteorApolloConfig.userFields);\n      }\n\n      return {\n        ...defaultContext,\n        ...userContext,\n      };\n    }\n  };\n}\n\nfunction getSubscriptionConfig(meteorApolloConfig) {\n  return {\n    onConnect: async (connectionParams, webSocket, context) => {\n      const loginToken = connectionParams[AUTH_TOKEN_KEY];\n\n      return new Promise((resolve, reject) => {\n        if (loginToken) {\n          const userContext = getUserForContext(\n            loginToken,\n            meteorApolloConfig.userFields\n          ).then(userContext => {\n            resolve(userContext);\n          });\n        } else {\n          resolve({});\n        }\n      });\n    },\n  };\n}\n"]},"sourceType":"script","hash":"3878575a0f6bdbee30370757b696fb07340d70e7"}
