{"metadata":{},"options":{"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/simiontomoiaga/git/server/packages/cultofcoders:grapher/lib/namedQuery/expose/extension.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","jsx",["flow",{}],["flow",{}],"objectRestSpread","objectRestSpread","dynamicImport","asyncGenerators","classProperties","classPrivateProperties"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.x86_64"},"sourceFileName":"packages/cultofcoders:grapher/lib/namedQuery/expose/extension.js","filename":"/Users/simiontomoiaga/git/server/packages/cultofcoders:grapher/lib/namedQuery/expose/extension.js","passPerPreset":false,"envName":"development","cwd":"/Users/simiontomoiaga/git/server","root":"/Users/simiontomoiaga/git/server","plugins":[{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"generateLetDeclarations":true,"enforceStrictMode":false}},{"key":"syntax-flow","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"transform-flow-strip-types","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"ClassPrivateProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"transform-runtime","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"transform-meteor-dynamic-import","visitor":{"_exploded":{},"_verified":{},"CallExpression":{"enter":[null]}},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"transform-modules-commonjs","visitor":{"Program":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"allowTopLevelThis":true,"strictMode":false,"loose":true}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]}},"options":{"loose":true}}],"presets":[],"generatorOpts":{"filename":"/Users/simiontomoiaga/git/server/packages/cultofcoders:grapher/lib/namedQuery/expose/extension.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/cultofcoders:grapher/lib/namedQuery/expose/extension.js"}},"code":"let NamedQuery;\nmodule.link(\"../namedQuery.js\", {\n  default(v) {\n    NamedQuery = v;\n  }\n\n}, 0);\nlet ExposeSchema, ExposeDefaults;\nmodule.link(\"./schema.js\", {\n  ExposeSchema(v) {\n    ExposeSchema = v;\n  },\n\n  ExposeDefaults(v) {\n    ExposeDefaults = v;\n  }\n\n}, 1);\nlet mergeDeep;\nmodule.link(\"./lib/mergeDeep.js\", {\n  default(v) {\n    mergeDeep = v;\n  }\n\n}, 2);\nlet createGraph;\nmodule.link(\"../../query/lib/createGraph.js\", {\n  default(v) {\n    createGraph = v;\n  }\n\n}, 3);\nlet recursiveCompose;\nmodule.link(\"../../query/lib/recursiveCompose.js\", {\n  default(v) {\n    recursiveCompose = v;\n  }\n\n}, 4);\nlet prepareForProcess;\nmodule.link(\"../../query/lib/prepareForProcess.js\", {\n  default(v) {\n    prepareForProcess = v;\n  }\n\n}, 5);\nlet deepClone;\nmodule.link(\"lodash.clonedeep\", {\n  default(v) {\n    deepClone = v;\n  }\n\n}, 6);\nlet intersectDeep;\nmodule.link(\"../../query/lib/intersectDeep\", {\n  default(v) {\n    intersectDeep = v;\n  }\n\n}, 7);\nlet genCountEndpoint;\nmodule.link(\"../../query/counts/genEndpoint.server\", {\n  default(v) {\n    genCountEndpoint = v;\n  }\n\n}, 8);\nlet check;\nmodule.link(\"meteor/check\", {\n  check(v) {\n    check = v;\n  }\n\n}, 9);\n\n_.extend(NamedQuery.prototype, {\n  /**\n   * @param config\n   */\n  expose(config = {}) {\n    if (!Meteor.isServer) {\n      throw new Meteor.Error('invalid-environment', `You must run this in server-side code`);\n    }\n\n    if (this.isExposed) {\n      throw new Meteor.Error('query-already-exposed', `You have already exposed: \"${this.name}\" named query`);\n    }\n\n    this.exposeConfig = Object.assign({}, ExposeDefaults, config);\n    check(this.exposeConfig, ExposeSchema);\n\n    if (this.exposeConfig.validateParams) {\n      this.options.validateParams = this.exposeConfig.validateParams;\n    }\n\n    if (!this.isResolver) {\n      this._initNormalQuery();\n    } else {\n      this._initMethod();\n    }\n\n    this.isExposed = true;\n  },\n\n  /**\n   * Initializes a normal NamedQuery (normal == not a resolver)\n   * @private\n   */\n  _initNormalQuery() {\n    const config = this.exposeConfig;\n\n    if (config.method) {\n      this._initMethod();\n    }\n\n    if (config.publication) {\n      this._initPublication();\n    }\n\n    if (!config.method && !config.publication) {\n      throw new Meteor.Error('weird', 'If you want to expose your named query you need to specify at least one of [\"method\", \"publication\"] options to true');\n    }\n\n    this._initCountMethod();\n\n    this._initCountPublication();\n  },\n\n  /**\n   * Returns the embodied body of the request\n   * @param {*} _embody\n   * @param {*} body\n   */\n  doEmbodimentIfItApplies(body) {\n    // query is not exposed yet, so it doesn't have embodiment logic\n    if (!this.exposeConfig) {\n      return;\n    }\n\n    const {\n      embody\n    } = this.exposeConfig;\n\n    if (!embody) {\n      return;\n    }\n\n    if (_.isFunction(embody)) {\n      embody.call(this, body, this.params);\n    } else {\n      mergeDeep(body, embody);\n    }\n  },\n\n  /**\n   * @private\n   */\n  _initMethod() {\n    const self = this;\n    Meteor.methods({\n      [this.name](newParams) {\n        self._unblockIfNecessary(this); // security is done in the fetching because we provide a context\n\n\n        return self.clone(newParams).fetch(this);\n      }\n\n    });\n  },\n\n  /**\n   * @returns {void}\n   * @private\n   */\n  _initCountMethod() {\n    const self = this;\n    Meteor.methods({\n      [this.name + '.count'](newParams) {\n        self._unblockIfNecessary(this); // security is done in the fetching because we provide a context\n\n\n        return self.clone(newParams).getCount(this);\n      }\n\n    });\n  },\n\n  /**\n   * @returns {*}\n   * @private\n   */\n  _initCountPublication() {\n    const self = this;\n    genCountEndpoint(self.name, {\n      getCursor({\n        session\n      }) {\n        const query = self.clone(session.params);\n        return query.getCursorForCounting();\n      },\n\n      getSession(params) {\n        self.doValidateParams(params);\n\n        self._callFirewall(this, this.userId, params);\n\n        return {\n          name: self.name,\n          params\n        };\n      }\n\n    });\n  },\n\n  /**\n   * @private\n   */\n  _initPublication() {\n    const self = this;\n    Meteor.publishComposite(this.name, function (params = {}) {\n      const isScoped = !!self.options.scoped;\n\n      if (isScoped) {\n        this.enableScope();\n      }\n\n      self._unblockIfNecessary(this);\n\n      self.doValidateParams(params);\n\n      self._callFirewall(this, this.userId, params);\n\n      let body = deepClone(self.body);\n\n      if (params.$body) {\n        body = intersectDeep(body, params.$body);\n      }\n\n      self.doEmbodimentIfItApplies(body);\n      body = prepareForProcess(body, params);\n      const rootNode = createGraph(self.collection, body);\n      return recursiveCompose(rootNode, undefined, {\n        scoped: isScoped\n      });\n    });\n  },\n\n  /**\n   * @param context\n   * @param userId\n   * @param params\n   * @private\n   */\n  _callFirewall(context, userId, params) {\n    const {\n      firewall\n    } = this.exposeConfig;\n\n    if (!firewall) {\n      return;\n    }\n\n    if (_.isArray(firewall)) {\n      firewall.forEach(fire => {\n        fire.call(context, userId, params);\n      });\n    } else {\n      firewall.call(context, userId, params);\n    }\n  },\n\n  /**\n   * @param context\n   * @private\n   */\n  _unblockIfNecessary(context) {\n    if (this.exposeConfig.unblock) {\n      if (context.unblock) {\n        context.unblock();\n      }\n    }\n  }\n\n});","map":{"version":3,"sources":["packages/cultofcoders:grapher/lib/namedQuery/expose/extension.js"],"names":["NamedQuery","module","link","default","v","ExposeSchema","ExposeDefaults","mergeDeep","createGraph","recursiveCompose","prepareForProcess","deepClone","intersectDeep","genCountEndpoint","check","_","extend","prototype","expose","config","Meteor","isServer","Error","isExposed","name","exposeConfig","Object","assign","validateParams","options","isResolver","_initNormalQuery","_initMethod","method","publication","_initPublication","_initCountMethod","_initCountPublication","doEmbodimentIfItApplies","body","embody","isFunction","call","params","self","methods","newParams","_unblockIfNecessary","clone","fetch","getCount","getCursor","session","query","getCursorForCounting","getSession","doValidateParams","_callFirewall","userId","publishComposite","isScoped","scoped","enableScope","$body","rootNode","collection","undefined","context","firewall","isArray","forEach","fire","unblock"],"mappings":"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","sourcesContent":["import NamedQuery from '../namedQuery.js';\nimport { ExposeSchema, ExposeDefaults } from './schema.js';\nimport mergeDeep from './lib/mergeDeep.js';\nimport createGraph from '../../query/lib/createGraph.js';\nimport recursiveCompose from '../../query/lib/recursiveCompose.js';\nimport prepareForProcess from '../../query/lib/prepareForProcess.js';\nimport deepClone from 'lodash.clonedeep';\nimport intersectDeep from '../../query/lib/intersectDeep';\nimport genCountEndpoint from '../../query/counts/genEndpoint.server';\nimport { check } from 'meteor/check';\n\n_.extend(NamedQuery.prototype, {\n    /**\n     * @param config\n     */\n    expose(config = {}) {\n        if (!Meteor.isServer) {\n            throw new Meteor.Error(\n                'invalid-environment',\n                `You must run this in server-side code`\n            );\n        }\n\n        if (this.isExposed) {\n            throw new Meteor.Error(\n                'query-already-exposed',\n                `You have already exposed: \"${this.name}\" named query`\n            );\n        }\n\n        this.exposeConfig = Object.assign({}, ExposeDefaults, config);\n        check(this.exposeConfig, ExposeSchema);\n\n        if (this.exposeConfig.validateParams) {\n            this.options.validateParams = this.exposeConfig.validateParams;\n        }\n\n        if (!this.isResolver) {\n            this._initNormalQuery();\n        } else {\n            this._initMethod();\n        }\n\n        this.isExposed = true;\n    },\n\n    /**\n     * Initializes a normal NamedQuery (normal == not a resolver)\n     * @private\n     */\n    _initNormalQuery() {\n        const config = this.exposeConfig;\n        if (config.method) {\n            this._initMethod();\n        }\n\n        if (config.publication) {\n            this._initPublication();\n        }\n\n        if (!config.method && !config.publication) {\n            throw new Meteor.Error(\n                'weird',\n                'If you want to expose your named query you need to specify at least one of [\"method\", \"publication\"] options to true'\n            );\n        }\n\n        this._initCountMethod();\n        this._initCountPublication();\n    },\n\n    /**\n     * Returns the embodied body of the request\n     * @param {*} _embody\n     * @param {*} body\n     */\n    doEmbodimentIfItApplies(body) {\n        // query is not exposed yet, so it doesn't have embodiment logic\n        if (!this.exposeConfig) {\n            return;\n        }\n\n        const { embody } = this.exposeConfig;\n\n        if (!embody) {\n            return;\n        }\n\n        if (_.isFunction(embody)) {\n            embody.call(this, body, this.params);\n        } else {\n            mergeDeep(body, embody);\n        }\n    },\n\n    /**\n     * @private\n     */\n    _initMethod() {\n        const self = this;\n        Meteor.methods({\n            [this.name](newParams) {\n                self._unblockIfNecessary(this);\n\n                // security is done in the fetching because we provide a context\n                return self.clone(newParams).fetch(this);\n            },\n        });\n    },\n\n    /**\n     * @returns {void}\n     * @private\n     */\n    _initCountMethod() {\n        const self = this;\n\n        Meteor.methods({\n            [this.name + '.count'](newParams) {\n                self._unblockIfNecessary(this);\n\n                // security is done in the fetching because we provide a context\n                return self.clone(newParams).getCount(this);\n            },\n        });\n    },\n\n    /**\n     * @returns {*}\n     * @private\n     */\n    _initCountPublication() {\n        const self = this;\n\n        genCountEndpoint(self.name, {\n            getCursor({ session }) {\n                const query = self.clone(session.params);\n                return query.getCursorForCounting();\n            },\n\n            getSession(params) {\n                self.doValidateParams(params);\n                self._callFirewall(this, this.userId, params);\n\n                return { name: self.name, params, };\n            },\n        });\n    },\n\n    /**\n     * @private\n     */\n    _initPublication() {\n        const self = this;\n\n        Meteor.publishComposite(this.name, function(params = {}) {\n            const isScoped = !!self.options.scoped;\n\n            if (isScoped) {\n                this.enableScope();\n            }\n\n            self._unblockIfNecessary(this);\n            self.doValidateParams(params);\n            self._callFirewall(this, this.userId, params);\n\n            let body = deepClone(self.body);\n            if (params.$body) {\n                body = intersectDeep(body, params.$body);\n            }\n\n            self.doEmbodimentIfItApplies(body);\n            body = prepareForProcess(body, params);\n\n            const rootNode = createGraph(self.collection, body);\n\n            return recursiveCompose(rootNode, undefined, {scoped: isScoped});\n        });\n    },\n\n    /**\n     * @param context\n     * @param userId\n     * @param params\n     * @private\n     */\n    _callFirewall(context, userId, params) {\n        const { firewall } = this.exposeConfig;\n        if (!firewall) {\n            return;\n        }\n\n        if (_.isArray(firewall)) {\n            firewall.forEach(fire => {\n                fire.call(context, userId, params);\n            });\n        } else {\n            firewall.call(context, userId, params);\n        }\n    },\n\n    /**\n     * @param context\n     * @private\n     */\n    _unblockIfNecessary(context) {\n        if (this.exposeConfig.unblock) {\n            if (context.unblock) {\n                context.unblock();\n            }\n        }\n    },\n});\n"]},"sourceType":"script","hash":"75f1844a76d33051c41f9a27a9152bc1af028b69"}
