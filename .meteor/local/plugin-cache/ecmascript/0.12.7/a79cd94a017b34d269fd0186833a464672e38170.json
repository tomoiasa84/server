{"metadata":{},"options":{"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/simiontomoiaga/git/server/packages/cultofcoders:grapher/lib/graphql/lib/astToQuery.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","jsx",["flow",{}],["flow",{}],"objectRestSpread","objectRestSpread","dynamicImport","asyncGenerators","classProperties","classPrivateProperties"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.x86_64"},"sourceFileName":"packages/cultofcoders:grapher/lib/graphql/lib/astToQuery.js","filename":"/Users/simiontomoiaga/git/server/packages/cultofcoders:grapher/lib/graphql/lib/astToQuery.js","passPerPreset":false,"envName":"development","cwd":"/Users/simiontomoiaga/git/server","root":"/Users/simiontomoiaga/git/server","plugins":[{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"generateLetDeclarations":true,"enforceStrictMode":false}},{"key":"syntax-flow","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"transform-flow-strip-types","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"ClassPrivateProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"transform-runtime","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"transform-meteor-dynamic-import","visitor":{"_exploded":{},"_verified":{},"CallExpression":{"enter":[null]}},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"transform-modules-commonjs","visitor":{"Program":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"allowTopLevelThis":true,"strictMode":false,"loose":true}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]}},"options":{"loose":true}}],"presets":[],"generatorOpts":{"filename":"/Users/simiontomoiaga/git/server/packages/cultofcoders:grapher/lib/graphql/lib/astToQuery.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/cultofcoders:grapher/lib/graphql/lib/astToQuery.js"}},"code":"module.export({\n  default: () => astToQuery,\n  getMaxDepth: () => getMaxDepth,\n  deny: () => deny,\n  clearEmptyObjects: () => clearEmptyObjects,\n  createGetArgs: () => createGetArgs\n});\nlet check, Match;\nmodule.link(\"meteor/check\", {\n  check(v) {\n    check = v;\n  },\n\n  Match(v) {\n    Match = v;\n  }\n\n}, 0);\nlet astToBody, Symbols;\nmodule.link(\"./astToBody\", {\n  default(v) {\n    astToBody = v;\n  },\n\n  Symbols(v) {\n    Symbols = v;\n  }\n\n}, 1);\nlet defaults;\nmodule.link(\"./defaults\", {\n  default(v) {\n    defaults = v;\n  }\n\n}, 2);\nlet intersectDeep;\nmodule.link(\"../../query/lib/intersectDeep\", {\n  default(v) {\n    intersectDeep = v;\n  }\n\n}, 3);\nlet enforceMaxLimit;\nmodule.link(\"../../exposure/lib/enforceMaxLimit\", {\n  default(v) {\n    enforceMaxLimit = v;\n  }\n\n}, 4);\nconst Errors = {\n  MAX_DEPTH: 'The maximum depth of this request exceeds the depth allowed.'\n};\n\nfunction astToQuery(ast, config = {}) {\n  const collection = this;\n  check(config, {\n    embody: Match.Maybe(Function),\n    $filters: Match.Maybe(Object),\n    $options: Match.Maybe(Object),\n    maxDepth: Match.Maybe(Number),\n    maxLimit: Match.Maybe(Number),\n    deny: Match.Maybe([String]),\n    intersect: Match.Maybe(Object)\n  });\n  config = Object.assign({\n    $options: {},\n    $filters: {}\n  }, defaults, config); // get the body\n\n  let body = astToBody(ast); // first we do the intersection\n\n  if (config.intersect) {\n    body = intersectDeep(config.intersect, body);\n  } // enforce the maximum amount of data we allow to retrieve\n\n\n  if (config.maxLimit) {\n    enforceMaxLimit(config.$options, config.maxLimit);\n  } // figure out depth based\n\n\n  if (config.maxDepth) {\n    const currentMaxDepth = getMaxDepth(body);\n\n    if (currentMaxDepth > config.maxDepth) {\n      throw Errors.MAX_DEPTH;\n    }\n  }\n\n  if (config.deny) {\n    deny(body, config.deny);\n  }\n\n  Object.assign(body, {\n    $filters: config.$filters,\n    $options: config.$options\n  });\n\n  if (config.embody) {\n    const getArgs = createGetArgs(body);\n    config.embody.call(null, {\n      body,\n      getArgs\n    });\n  } // we return the query\n\n\n  return this.createQuery(body);\n}\n\nfunction getMaxDepth(body) {\n  let depths = [];\n\n  for (key in body) {\n    if (_.isObject(body[key])) {\n      depths.push(getMaxDepth(body[key]));\n    }\n  }\n\n  if (depths.length === 0) {\n    return 1;\n  }\n\n  return Math.max(...depths) + 1;\n}\n\nfunction deny(body, fields) {\n  fields.forEach(field => {\n    let parts = field.split('.');\n    let accessor = body;\n\n    while (parts.length != 0) {\n      if (parts.length === 1) {\n        delete accessor[parts[0]];\n      } else {\n        if (!_.isObject(accessor)) {\n          break;\n        }\n\n        accessor = accessor[parts[0]];\n      }\n\n      parts.shift();\n    }\n  });\n  return clearEmptyObjects(body);\n}\n\nfunction clearEmptyObjects(body) {\n  // clear empty nodes then back-propagate\n  for (let key in body) {\n    if (_.isObject(body[key])) {\n      const shouldDelete = clearEmptyObjects(body[key]);\n\n      if (shouldDelete) {\n        delete body[key];\n      }\n    }\n  }\n\n  return Object.keys(body).length === 0;\n}\n\nfunction createGetArgs(body) {\n  return function (path) {\n    const parts = path.split('.');\n    let stopped = false;\n    let accessor = body;\n\n    for (var i = 0; i < parts.length; i++) {\n      if (!accessor) {\n        stopped = true;\n        break;\n      }\n\n      if (accessor[parts[i]]) {\n        accessor = accessor[parts[i]];\n      }\n    }\n\n    if (stopped) {\n      return {};\n    }\n\n    if (accessor) {\n      return accessor[Symbols.ARGUMENTS] || {};\n    }\n  };\n}","map":{"version":3,"sources":["packages/cultofcoders:grapher/lib/graphql/lib/astToQuery.js"],"names":["module","export","default","astToQuery","getMaxDepth","deny","clearEmptyObjects","createGetArgs","check","Match","link","v","astToBody","Symbols","defaults","intersectDeep","enforceMaxLimit","Errors","MAX_DEPTH","ast","config","collection","embody","Maybe","Function","$filters","Object","$options","maxDepth","Number","maxLimit","String","intersect","assign","body","currentMaxDepth","getArgs","call","createQuery","depths","key","_","isObject","push","length","Math","max","fields","forEach","field","parts","split","accessor","shift","shouldDelete","keys","path","stopped","i","ARGUMENTS"],"mappings":"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","sourcesContent":["import { check, Match } from 'meteor/check';\nimport astToBody, { Symbols } from './astToBody';\nimport defaults from './defaults';\nimport intersectDeep from '../../query/lib/intersectDeep';\nimport enforceMaxLimit from '../../exposure/lib/enforceMaxLimit';\n\nconst Errors = {\n  MAX_DEPTH: 'The maximum depth of this request exceeds the depth allowed.',\n};\n\nexport default function astToQuery(ast, config = {}) {\n  const collection = this;\n\n  check(config, {\n    embody: Match.Maybe(Function),\n    $filters: Match.Maybe(Object),\n    $options: Match.Maybe(Object),\n    maxDepth: Match.Maybe(Number),\n    maxLimit: Match.Maybe(Number),\n    deny: Match.Maybe([String]),\n    intersect: Match.Maybe(Object),\n  });\n\n  config = Object.assign(\n    {\n      $options: {},\n      $filters: {},\n    },\n    defaults,\n    config\n  );\n\n  // get the body\n  let body = astToBody(ast);\n\n  // first we do the intersection\n  if (config.intersect) {\n    body = intersectDeep(config.intersect, body);\n  }\n\n  // enforce the maximum amount of data we allow to retrieve\n  if (config.maxLimit) {\n    enforceMaxLimit(config.$options, config.maxLimit);\n  }\n\n  // figure out depth based\n  if (config.maxDepth) {\n    const currentMaxDepth = getMaxDepth(body);\n    if (currentMaxDepth > config.maxDepth) {\n      throw Errors.MAX_DEPTH;\n    }\n  }\n\n  if (config.deny) {\n    deny(body, config.deny);\n  }\n\n  Object.assign(body, {\n    $filters: config.$filters,\n    $options: config.$options,\n  });\n\n  if (config.embody) {\n    const getArgs = createGetArgs(body);\n    config.embody.call(null, {\n      body,\n      getArgs,\n    });\n  }\n\n  // we return the query\n  return this.createQuery(body);\n}\n\nexport function getMaxDepth(body) {\n  let depths = [];\n  for (key in body) {\n    if (_.isObject(body[key])) {\n      depths.push(getMaxDepth(body[key]));\n    }\n  }\n\n  if (depths.length === 0) {\n    return 1;\n  }\n\n  return Math.max(...depths) + 1;\n}\n\nexport function deny(body, fields) {\n  fields.forEach(field => {\n    let parts = field.split('.');\n    let accessor = body;\n    while (parts.length != 0) {\n      if (parts.length === 1) {\n        delete accessor[parts[0]];\n      } else {\n        if (!_.isObject(accessor)) {\n          break;\n        }\n        accessor = accessor[parts[0]];\n      }\n      parts.shift();\n    }\n  });\n\n  return clearEmptyObjects(body);\n}\n\nexport function clearEmptyObjects(body) {\n  // clear empty nodes then back-propagate\n  for (let key in body) {\n    if (_.isObject(body[key])) {\n      const shouldDelete = clearEmptyObjects(body[key]);\n      if (shouldDelete) {\n        delete body[key];\n      }\n    }\n  }\n\n  return Object.keys(body).length === 0;\n}\n\nexport function createGetArgs(body) {\n  return function(path) {\n    const parts = path.split('.');\n    let stopped = false;\n    let accessor = body;\n    for (var i = 0; i < parts.length; i++) {\n      if (!accessor) {\n        stopped = true;\n        break;\n      }\n\n      if (accessor[parts[i]]) {\n        accessor = accessor[parts[i]];\n      }\n    }\n\n    if (stopped) {\n      return {};\n    }\n\n    if (accessor) {\n      return accessor[Symbols.ARGUMENTS] || {};\n    }\n  };\n}\n"]},"sourceType":"script","hash":"a79cd94a017b34d269fd0186833a464672e38170"}
