{"metadata":{},"options":{"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/simiontomoiaga/git/server/packages/herteby:denormalize/migrations.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","jsx",["flow",{}],["flow",{}],"objectRestSpread","objectRestSpread","dynamicImport","asyncGenerators","classProperties","classPrivateProperties"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.x86_64"},"sourceFileName":"packages/herteby:denormalize/migrations.js","filename":"/Users/simiontomoiaga/git/server/packages/herteby:denormalize/migrations.js","passPerPreset":false,"envName":"development","cwd":"/Users/simiontomoiaga/git/server","root":"/Users/simiontomoiaga/git/server","plugins":[{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"generateLetDeclarations":true,"enforceStrictMode":false}},{"key":"syntax-flow","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"transform-flow-strip-types","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"ClassPrivateProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"transform-runtime","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"transform-meteor-dynamic-import","visitor":{"_exploded":{},"_verified":{},"CallExpression":{"enter":[null]}},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"transform-modules-commonjs","visitor":{"Program":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"allowTopLevelThis":true,"strictMode":false,"loose":true}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]}},"options":{"loose":true}}],"presets":[],"generatorOpts":{"filename":"/Users/simiontomoiaga/git/server/packages/herteby:denormalize/migrations.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/herteby:denormalize/migrations.js"}},"code":"module.export({\n  MigrationHistory: () => MigrationHistory,\n  addMigration: () => addMigration,\n  migrate: () => migrate,\n  autoMigrate: () => autoMigrate\n});\n\nlet _;\n\nmodule.link(\"lodash\", {\n  default(v) {\n    _ = v;\n  }\n\n}, 0);\nlet Mongo;\nmodule.link(\"meteor/mongo\", {\n  Mongo(v) {\n    Mongo = v;\n  }\n\n}, 1);\nlet settings;\nmodule.link(\"./cache.js\", {\n  default(v) {\n    settings = v;\n  }\n\n}, 2);\nconst MigrationHistory = new Mongo.Collection('_cacheMigrations');\nlet migrations = [];\n\nfunction addMigration(collection, insertFn, options) {\n  let opts = _.clone(options);\n\n  if (opts.collection) {\n    //prevent Error: Converting circular structure to JSON\n    opts.collection = opts.collection._name;\n  }\n\n  opts = JSON.stringify(opts);\n  migrations.push({\n    options: opts,\n    collectionName: collection._name,\n    collection: collection,\n    cacheField: options.cacheField,\n    fn: insertFn\n  });\n}\n\nfunction migrate(collectionName, cacheField, selector) {\n  let migration = _.find(migrations, {\n    collectionName,\n    cacheField\n  });\n\n  if (!migration) {\n    throw new Error('no migration found for ' + collectionName + ' - ' + cacheField);\n  } else {\n    let time = new Date();\n    let n = 0;\n    migration.collection.find(selector || {}).forEach(doc => {\n      migration.fn(null, doc);\n      n++;\n    });\n    console.log(`migrated ${cacheField} of ${n} docs in ${collectionName + (selector ? ' matching ' + JSON.stringify(selector) : '')}. It took ${new Date() - time}ms`);\n  }\n}\n\nfunction autoMigrate() {\n  _.each(migrations, migration => {\n    if (!MigrationHistory.findOne({\n      collectionName: migration.collectionName,\n      options: migration.options\n    })) {\n      migrate(migration.collectionName, migration.cacheField);\n      MigrationHistory.insert({\n        collectionName: migration.collectionName,\n        options: migration.options,\n        date: new Date()\n      });\n    }\n  });\n}","map":{"version":3,"sources":["packages/herteby:denormalize/migrations.js"],"names":["module","export","MigrationHistory","addMigration","migrate","autoMigrate","_","link","default","v","Mongo","settings","Collection","migrations","collection","insertFn","options","opts","clone","_name","JSON","stringify","push","collectionName","cacheField","fn","selector","migration","find","Error","time","Date","n","forEach","doc","console","log","each","findOne","insert","date"],"mappings":"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","sourcesContent":["import _ from 'lodash'\nimport {Mongo} from 'meteor/mongo'\nimport settings from './cache.js'\n\nexport const MigrationHistory = new Mongo.Collection('_cacheMigrations')\n\nlet migrations = []\n\nexport function addMigration(collection, insertFn, options){\n  let opts = _.clone(options)\n  if(opts.collection){ //prevent Error: Converting circular structure to JSON\n    opts.collection = opts.collection._name\n  }\n  opts = JSON.stringify(opts)\n  migrations.push({\n    options:opts,\n    collectionName:collection._name,\n    collection:collection,\n    cacheField:options.cacheField,\n    fn:insertFn\n  })\n}\n\nexport function migrate(collectionName, cacheField, selector){\n  let migration = _.find(migrations, {collectionName, cacheField})\n  if(!migration){\n    throw new Error('no migration found for ' + collectionName + ' - ' + cacheField)\n  } else {\n    let time = new Date()\n    let n = 0\n    migration.collection.find(selector || {}).forEach(doc => {\n      migration.fn(null, doc)\n      n++\n    })\n    console.log(`migrated ${cacheField} of ${n} docs in ${collectionName + (selector ? ' matching ' + JSON.stringify(selector) : '')}. It took ${new Date() - time}ms`)\n  }\n}\n\nexport function autoMigrate(){\n  _.each(migrations, migration => {\n    if(!MigrationHistory.findOne({collectionName:migration.collectionName, options:migration.options})){\n      migrate(migration.collectionName, migration.cacheField)\n      MigrationHistory.insert({\n        collectionName:migration.collectionName,\n        options:migration.options,\n        date:new Date()\n      })\n    }    \n  })\n}"]},"sourceType":"script","hash":"239cd273de09ca6ee0ed2a42164e1b53b8c2f30b"}
