{"metadata":{},"options":{"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/simiontomoiaga/git/server/packages/cultofcoders:grapher/lib/namedQuery/namedQuery.server.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","dynamicImport","classProperties","classPrivateProperties","jsx",["flow",{}],"asyncGenerators","objectRestSpread","objectRestSpread",["flow",{}],"asyncGenerators"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser.legacy"},"sourceFileName":"packages/cultofcoders:grapher/lib/namedQuery/namedQuery.server.js","filename":"/Users/simiontomoiaga/git/server/packages/cultofcoders:grapher/lib/namedQuery/namedQuery.server.js","passPerPreset":false,"envName":"development","cwd":"/Users/simiontomoiaga/git/server","root":"/Users/simiontomoiaga/git/server","plugins":[{"key":"base$0$0","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"generateLetDeclarations":true,"enforceStrictMode":false}},{"key":"transform-meteor-dynamic-import","visitor":{"_exploded":{},"_verified":{},"CallExpression":{"enter":[null]}},"options":{}},{"key":"transform-runtime","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]}},"options":{"loose":true}},{"key":"base$0$4","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$5","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-modules-commonjs","visitor":{"Program":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"allowTopLevelThis":true,"strictMode":false,"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-flow","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"transform-arrow-functions","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoped-functions","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoping","visitor":{"VariableDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"_exploded":true,"BlockStatement":{"enter":[null]},"SwitchStatement":{"enter":[null]},"Program":{"enter":[null]},"_verified":true,"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-classes","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-computed-properties","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-destructuring","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-object-super","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-shorthand-properties","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-spread","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-sticky-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-typeof-symbol","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-unicode-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-property-literals","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-flow-strip-types","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"ClassPrivateProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"regenerator-transform","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/simiontomoiaga/git/server/packages/cultofcoders:grapher/lib/namedQuery/namedQuery.server.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/cultofcoders:grapher/lib/namedQuery/namedQuery.server.js"}},"code":"var _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nvar _inheritsLoose2 = _interopRequireDefault(require(\"@babel/runtime/helpers/inheritsLoose\"));\n\nvar prepareForProcess;\nmodule.link(\"../query/lib/prepareForProcess.js\", {\n  \"default\": function (v) {\n    prepareForProcess = v;\n  }\n}, 0);\nvar Base;\nmodule.link(\"./namedQuery.base\", {\n  \"default\": function (v) {\n    Base = v;\n  }\n}, 1);\nvar deepClone;\nmodule.link(\"lodash.clonedeep\", {\n  \"default\": function (v) {\n    deepClone = v;\n  }\n}, 2);\nvar MemoryResultCacher;\nmodule.link(\"./cache/MemoryResultCacher\", {\n  \"default\": function (v) {\n    MemoryResultCacher = v;\n  }\n}, 3);\nvar intersectDeep;\nmodule.link(\"../query/lib/intersectDeep\", {\n  \"default\": function (v) {\n    intersectDeep = v;\n  }\n}, 4);\nmodule.exportDefault(\n/*#__PURE__*/\nfunction (_Base) {\n  (0, _inheritsLoose2.default)(_class, _Base);\n\n  function _class() {\n    return _Base.apply(this, arguments) || this;\n  }\n\n  var _proto = _class.prototype;\n\n  /**\n   * Retrieves the data.\n   * @returns {*}\n   */\n  _proto.fetch = function () {\n    function fetch(context) {\n      this._performSecurityChecks(context, this.params);\n\n      if (this.isResolver) {\n        return this._fetchResolverData(context);\n      } else {\n        body = deepClone(this.body);\n\n        if (this.params.$body) {\n          body = intersectDeep(body, this.params.$body);\n        } // we must apply emobdyment here\n\n\n        this.doEmbodimentIfItApplies(body);\n        var query = this.collection.createQuery(deepClone(body), {\n          params: deepClone(this.params)\n        });\n\n        if (this.cacher) {\n          var cacheId = this.cacher.generateQueryId(this.queryName, this.params);\n          return this.cacher.fetch(cacheId, {\n            query: query\n          });\n        }\n\n        return query.fetch();\n      }\n    }\n\n    return fetch;\n  }()\n  /**\n   * @param args\n   * @returns {*}\n   */\n  ;\n\n  _proto.fetchOne = function () {\n    function fetchOne() {\n      return _.first(this.fetch.apply(this, arguments));\n    }\n\n    return fetchOne;\n  }()\n  /**\n   * Gets the count of matching elements.\n   *\n   * @returns {any}\n   */\n  ;\n\n  _proto.getCount = function () {\n    function getCount(context) {\n      this._performSecurityChecks(context, this.params);\n\n      var countCursor = this.getCursorForCounting();\n\n      if (this.cacher) {\n        var cacheId = 'count::' + this.cacher.generateQueryId(this.queryName, this.params);\n        return this.cacher.fetch(cacheId, {\n          countCursor: countCursor\n        });\n      }\n\n      return countCursor.count();\n    }\n\n    return getCount;\n  }()\n  /**\n   * Returns the cursor for counting\n   * This is most likely used for counts cursor\n   */\n  ;\n\n  _proto.getCursorForCounting = function () {\n    function getCursorForCounting() {\n      var body = deepClone(this.body);\n      this.doEmbodimentIfItApplies(body);\n      body = prepareForProcess(body, this.params);\n      return this.collection.find(body.$filters || {}, {\n        fields: {\n          _id: 1\n        }\n      });\n    }\n\n    return getCursorForCounting;\n  }()\n  /**\n   * @param cacher\n   */\n  ;\n\n  _proto.cacheResults = function () {\n    function cacheResults(cacher) {\n      if (!cacher) {\n        cacher = new MemoryResultCacher();\n      }\n\n      this.cacher = cacher;\n    }\n\n    return cacheResults;\n  }()\n  /**\n   * Configure resolve. This doesn't actually call the resolver, it just sets it\n   * @param fn\n   */\n  ;\n\n  _proto.resolve = function () {\n    function resolve(fn) {\n      if (!this.isResolver) {\n        throw new Meteor.Error('invalid-call', \"You cannot use resolve() on a non resolver NamedQuery\");\n      }\n\n      this.resolver = fn;\n    }\n\n    return resolve;\n  }()\n  /**\n   * @returns {*}\n   * @private\n   */\n  ;\n\n  _proto._fetchResolverData = function () {\n    function _fetchResolverData(context) {\n      var resolver = this.resolver;\n      var self = this;\n      var query = {\n        fetch: function () {\n          return resolver.call(context, self.params);\n        }\n      };\n\n      if (this.cacher) {\n        var cacheId = this.cacher.generateQueryId(this.queryName, this.params);\n        return this.cacher.fetch(cacheId, {\n          query: query\n        });\n      }\n\n      return query.fetch();\n    }\n\n    return _fetchResolverData;\n  }()\n  /**\n   * @param context Meteor method/publish context\n   * @param params\n   *\n   * @private\n   */\n  ;\n\n  _proto._performSecurityChecks = function () {\n    function _performSecurityChecks(context, params) {\n      if (context && this.exposeConfig) {\n        this._callFirewall(context, context.userId, params);\n      }\n\n      this.doValidateParams(params);\n    }\n\n    return _performSecurityChecks;\n  }();\n\n  return _class;\n}(Base));","map":{"version":3,"sources":["packages/cultofcoders:grapher/lib/namedQuery/namedQuery.server.js"],"names":["prepareForProcess","module","link","v","Base","deepClone","MemoryResultCacher","intersectDeep","exportDefault","fetch","context","_performSecurityChecks","params","isResolver","_fetchResolverData","body","$body","doEmbodimentIfItApplies","query","collection","createQuery","cacher","cacheId","generateQueryId","queryName","fetchOne","_","first","getCount","countCursor","getCursorForCounting","count","find","$filters","fields","_id","cacheResults","resolve","fn","Meteor","Error","resolver","self","call","exposeConfig","_callFirewall","userId","doValidateParams"],"mappings":"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","sourcesContent":["import prepareForProcess from '../query/lib/prepareForProcess.js';\nimport Base from './namedQuery.base';\nimport deepClone from 'lodash.clonedeep';\nimport MemoryResultCacher from './cache/MemoryResultCacher';\nimport intersectDeep from '../query/lib/intersectDeep';\n\nexport default class extends Base {\n    /**\n     * Retrieves the data.\n     * @returns {*}\n     */\n    fetch(context) {\n        this._performSecurityChecks(context, this.params);\n\n        if (this.isResolver) {\n            return this._fetchResolverData(context);\n        } else {\n            body = deepClone(this.body);\n            if (this.params.$body) {\n                body = intersectDeep(body, this.params.$body);\n            }\n            \n            // we must apply emobdyment here\n            this.doEmbodimentIfItApplies(body);\n\n            const query = this.collection.createQuery(\n                deepClone(body),\n                {\n                    params: deepClone(this.params)\n                }\n            );\n\n            if (this.cacher) {\n                const cacheId = this.cacher.generateQueryId(this.queryName, this.params);\n                return this.cacher.fetch(cacheId, {query});\n            }\n\n            return query.fetch();\n        }\n    }\n\n    /**\n     * @param args\n     * @returns {*}\n     */\n    fetchOne(...args) {\n        return _.first(this.fetch(...args));\n    }\n\n    /**\n     * Gets the count of matching elements.\n     *\n     * @returns {any}\n     */\n    getCount(context) {\n        this._performSecurityChecks(context, this.params);\n\n        const countCursor = this.getCursorForCounting();\n\n        if (this.cacher) {\n            const cacheId = 'count::' + this.cacher.generateQueryId(this.queryName, this.params);\n\n            return this.cacher.fetch(cacheId, {countCursor});\n        }\n\n        return countCursor.count();\n    }\n\n    /**\n     * Returns the cursor for counting\n     * This is most likely used for counts cursor\n     */\n    getCursorForCounting() {\n        let body = deepClone(this.body);\n        this.doEmbodimentIfItApplies(body);\n        body = prepareForProcess(body, this.params);\n\n        return this.collection.find(body.$filters || {}, {fields: {_id: 1}});\n    }\n\n    /**\n     * @param cacher\n     */\n    cacheResults(cacher) {\n        if (!cacher) {\n            cacher = new MemoryResultCacher();\n        }\n\n        this.cacher = cacher;\n    }\n\n    /**\n     * Configure resolve. This doesn't actually call the resolver, it just sets it\n     * @param fn\n     */\n    resolve(fn) {\n        if (!this.isResolver) {\n            throw new Meteor.Error('invalid-call', `You cannot use resolve() on a non resolver NamedQuery`);\n        }\n\n        this.resolver = fn;\n    }\n\n    /**\n     * @returns {*}\n     * @private\n     */\n    _fetchResolverData(context) {\n        const resolver = this.resolver;\n        const self = this;\n        const query = {\n            fetch() {\n                return resolver.call(context, self.params);\n            }\n        };\n\n        if (this.cacher) {\n            const cacheId = this.cacher.generateQueryId(this.queryName, this.params);\n            return this.cacher.fetch(cacheId, {query});\n        }\n\n        return query.fetch();\n    }\n\n    /**\n     * @param context Meteor method/publish context\n     * @param params\n     *\n     * @private\n     */\n    _performSecurityChecks(context, params) {\n        if (context && this.exposeConfig) {\n            this._callFirewall(context, context.userId, params);\n        }\n\n        this.doValidateParams(params);\n    }\n}"]},"sourceType":"script","hash":"16b65bb7ed5b9d9f76d3946748d56dccf788d045"}
