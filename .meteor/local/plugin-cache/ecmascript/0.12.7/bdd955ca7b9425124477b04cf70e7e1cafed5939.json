{"metadata":{},"options":{"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/simiontomoiaga/git/server/packages/cultofcoders:grapher/lib/namedQuery/namedQuery.client.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","jsx",["flow",{}],["flow",{}],"objectRestSpread","objectRestSpread","dynamicImport","asyncGenerators","classProperties","classPrivateProperties"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.x86_64"},"sourceFileName":"packages/cultofcoders:grapher/lib/namedQuery/namedQuery.client.js","filename":"/Users/simiontomoiaga/git/server/packages/cultofcoders:grapher/lib/namedQuery/namedQuery.client.js","passPerPreset":false,"envName":"development","cwd":"/Users/simiontomoiaga/git/server","root":"/Users/simiontomoiaga/git/server","plugins":[{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"generateLetDeclarations":true,"enforceStrictMode":false}},{"key":"syntax-flow","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"transform-flow-strip-types","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"ClassPrivateProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"transform-runtime","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"transform-meteor-dynamic-import","visitor":{"_exploded":{},"_verified":{},"CallExpression":{"enter":[null]}},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"transform-modules-commonjs","visitor":{"Program":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"allowTopLevelThis":true,"strictMode":false,"loose":true}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]}},"options":{"loose":true}}],"presets":[],"generatorOpts":{"filename":"/Users/simiontomoiaga/git/server/packages/cultofcoders:grapher/lib/namedQuery/namedQuery.client.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/cultofcoders:grapher/lib/namedQuery/namedQuery.client.js"}},"code":"let CountSubscription;\nmodule.link(\"../query/counts/countSubscription\", {\n  default(v) {\n    CountSubscription = v;\n  }\n\n}, 0);\nlet createGraph;\nmodule.link(\"../query/lib/createGraph.js\", {\n  default(v) {\n    createGraph = v;\n  }\n\n}, 1);\nlet recursiveFetch;\nmodule.link(\"../query/lib/recursiveFetch.js\", {\n  default(v) {\n    recursiveFetch = v;\n  }\n\n}, 2);\nlet prepareForProcess;\nmodule.link(\"../query/lib/prepareForProcess.js\", {\n  default(v) {\n    prepareForProcess = v;\n  }\n\n}, 3);\n\nlet _;\n\nmodule.link(\"meteor/underscore\", {\n  _(v) {\n    _ = v;\n  }\n\n}, 4);\nlet callWithPromise;\nmodule.link(\"../query/lib/callWithPromise\", {\n  default(v) {\n    callWithPromise = v;\n  }\n\n}, 5);\nlet Base;\nmodule.link(\"./namedQuery.base\", {\n  default(v) {\n    Base = v;\n  }\n\n}, 6);\nlet LocalCollection;\nmodule.link(\"meteor/minimongo\", {\n  LocalCollection(v) {\n    LocalCollection = v;\n  }\n\n}, 7);\nlet intersectDeep;\nmodule.link(\"../query/lib/intersectDeep\", {\n  default(v) {\n    intersectDeep = v;\n  }\n\n}, 8);\nmodule.exportDefault(class extends Base {\n  /**\n   * Subscribe\n   *\n   * @param callback\n   * @returns {null|any|*}\n   */\n  subscribe(callback) {\n    if (this.isResolver) {\n      throw new Meteor.Error('not-allowed', `You cannot subscribe to a resolver query`);\n    }\n\n    this.subscriptionHandle = Meteor.subscribe(this.name, this.params, callback);\n    return this.subscriptionHandle;\n  }\n  /**\n   * Subscribe to the counts for this query\n   *\n   * @param callback\n   * @returns {Object}\n   */\n\n\n  subscribeCount(callback) {\n    if (this.isResolver) {\n      throw new Meteor.Error('not-allowed', `You cannot subscribe to a resolver query`);\n    }\n\n    if (!this._counter) {\n      this._counter = new CountSubscription(this);\n    }\n\n    return this._counter.subscribe(this.params, callback);\n  }\n  /**\n   * Unsubscribe if an existing subscription exists\n   */\n\n\n  unsubscribe() {\n    if (this.subscriptionHandle) {\n      this.subscriptionHandle.stop();\n    }\n\n    this.subscriptionHandle = null;\n  }\n  /**\n   * Unsubscribe to the counts if a subscription exists.\n   */\n\n\n  unsubscribeCount() {\n    if (this._counter) {\n      this._counter.unsubscribe();\n\n      this._counter = null;\n    }\n  }\n  /**\n   * Fetches elements in sync using promises\n   * @return {*}\n   */\n\n\n  fetchSync() {\n    return Promise.asyncApply(() => {\n      if (this.subscriptionHandle) {\n        throw new Meteor.Error('This query is reactive, meaning you cannot use promises to fetch the data.');\n      }\n\n      return Promise.await(callWithPromise(this.name, this.params));\n    });\n  }\n  /**\n   * Fetches one element in sync\n   * @return {*}\n   */\n\n\n  fetchOneSync() {\n    return Promise.asyncApply(() => {\n      return _.first(Promise.await(this.fetchSync()));\n    });\n  }\n  /**\n   * Retrieves the data.\n   * @param callbackOrOptions\n   * @returns {*}\n   */\n\n\n  fetch(callbackOrOptions) {\n    if (!this.subscriptionHandle) {\n      return this._fetchStatic(callbackOrOptions);\n    } else {\n      return this._fetchReactive(callbackOrOptions);\n    }\n  }\n  /**\n   * @param args\n   * @returns {*}\n   */\n\n\n  fetchOne(...args) {\n    if (!this.subscriptionHandle) {\n      const callback = args[0];\n\n      if (!_.isFunction(callback)) {\n        throw new Meteor.Error('You did not provide a valid callback');\n      }\n\n      this.fetch((err, res) => {\n        callback(err, res ? _.first(res) : null);\n      });\n    } else {\n      return _.first(this.fetch(...args));\n    }\n  }\n  /**\n   * Gets the count of matching elements in sync.\n   * @returns {any}\n   */\n\n\n  getCountSync() {\n    return Promise.asyncApply(() => {\n      if (this._counter) {\n        throw new Meteor.Error('This query is reactive, meaning you cannot use promises to fetch the data.');\n      }\n\n      return Promise.await(callWithPromise(this.name + '.count', this.params));\n    });\n  }\n  /**\n   * Gets the count of matching elements.\n   * @param callback\n   * @returns {any}\n   */\n\n\n  getCount(callback) {\n    if (this._counter) {\n      return this._counter.getCount();\n    } else {\n      if (!callback) {\n        throw new Meteor.Error('not-allowed', 'You are on client so you must either provide a callback to get the count or subscribe first.');\n      } else {\n        return Meteor.call(this.name + '.count', this.params, callback);\n      }\n    }\n  }\n  /**\n   * Fetching non-reactive queries\n   * @param callback\n   * @private\n   */\n\n\n  _fetchStatic(callback) {\n    if (!callback) {\n      throw new Meteor.Error('not-allowed', 'You are on client so you must either provide a callback to get the data or subscribe first.');\n    }\n\n    Meteor.call(this.name, this.params, callback);\n  }\n  /**\n   * Fetching when we've got an active publication\n   *\n   * @param options\n   * @returns {*}\n   * @private\n   */\n\n\n  _fetchReactive(options = {}) {\n    let body = this.body;\n\n    if (this.params.$body) {\n      body = intersectDeep(body, this.params.$body);\n    }\n\n    body = prepareForProcess(body, this.params);\n\n    if (!options.allowSkip && body.$options && body.$options.skip) {\n      delete body.$options.skip;\n    }\n\n    return recursiveFetch(createGraph(this.collection, body), undefined, {\n      scoped: this.options.scoped,\n      subscriptionHandle: this.subscriptionHandle\n    });\n  }\n\n});","map":{"version":3,"sources":["packages/cultofcoders:grapher/lib/namedQuery/namedQuery.client.js"],"names":["CountSubscription","module","link","default","v","createGraph","recursiveFetch","prepareForProcess","_","callWithPromise","Base","LocalCollection","intersectDeep","exportDefault","subscribe","callback","isResolver","Meteor","Error","subscriptionHandle","name","params","subscribeCount","_counter","unsubscribe","stop","unsubscribeCount","fetchSync","fetchOneSync","first","fetch","callbackOrOptions","_fetchStatic","_fetchReactive","fetchOne","args","isFunction","err","res","getCountSync","getCount","call","options","body","$body","allowSkip","$options","skip","collection","undefined","scoped"],"mappings":"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","sourcesContent":["import CountSubscription from '../query/counts/countSubscription';\nimport createGraph from '../query/lib/createGraph.js';\nimport recursiveFetch from '../query/lib/recursiveFetch.js';\nimport prepareForProcess from '../query/lib/prepareForProcess.js';\nimport {_} from 'meteor/underscore';\nimport callWithPromise from '../query/lib/callWithPromise';\nimport Base from './namedQuery.base';\nimport {LocalCollection} from 'meteor/minimongo';\nimport intersectDeep from '../query/lib/intersectDeep';\n\nexport default class extends Base {\n    /**\n     * Subscribe\n     *\n     * @param callback\n     * @returns {null|any|*}\n     */\n    subscribe(callback) {\n        if (this.isResolver) {\n            throw new Meteor.Error('not-allowed', `You cannot subscribe to a resolver query`);\n        }\n\n        this.subscriptionHandle = Meteor.subscribe(\n            this.name,\n            this.params,\n            callback\n        );\n\n        return this.subscriptionHandle;\n    }\n\n    /**\n     * Subscribe to the counts for this query\n     *\n     * @param callback\n     * @returns {Object}\n     */\n    subscribeCount(callback) {\n        if (this.isResolver) {\n            throw new Meteor.Error('not-allowed', `You cannot subscribe to a resolver query`);\n        }\n\n        if (!this._counter) {\n            this._counter = new CountSubscription(this);\n        }\n\n        return this._counter.subscribe(this.params, callback);\n    }\n\n    /**\n     * Unsubscribe if an existing subscription exists\n     */\n    unsubscribe() {\n        if (this.subscriptionHandle) {\n            this.subscriptionHandle.stop();\n        }\n\n        this.subscriptionHandle = null;\n    }\n\n    /**\n     * Unsubscribe to the counts if a subscription exists.\n     */\n    unsubscribeCount() {\n        if (this._counter) {\n            this._counter.unsubscribe();\n            this._counter = null;\n        }\n    }\n\n    /**\n     * Fetches elements in sync using promises\n     * @return {*}\n     */\n    async fetchSync() {\n        if (this.subscriptionHandle) {\n            throw new Meteor.Error('This query is reactive, meaning you cannot use promises to fetch the data.');\n        }\n\n        return await callWithPromise(this.name, this.params);\n    }\n\n    /**\n     * Fetches one element in sync\n     * @return {*}\n     */\n    async fetchOneSync() {\n        return _.first(await this.fetchSync())\n    }\n\n    /**\n     * Retrieves the data.\n     * @param callbackOrOptions\n     * @returns {*}\n     */\n    fetch(callbackOrOptions) {\n        if (!this.subscriptionHandle) {\n            return this._fetchStatic(callbackOrOptions)\n        } else {\n            return this._fetchReactive(callbackOrOptions);\n        }\n    }\n\n    /**\n     * @param args\n     * @returns {*}\n     */\n    fetchOne(...args) {\n        if (!this.subscriptionHandle) {\n            const callback = args[0];\n            if (!_.isFunction(callback)) {\n                throw new Meteor.Error('You did not provide a valid callback');\n            }\n\n            this.fetch((err, res) => {\n                callback(err, res ? _.first(res) : null);\n            })\n        } else {\n            return _.first(this.fetch(...args));\n        }\n    }\n\n    /**\n     * Gets the count of matching elements in sync.\n     * @returns {any}\n     */\n    async getCountSync() {\n        if (this._counter) {\n            throw new Meteor.Error('This query is reactive, meaning you cannot use promises to fetch the data.');\n        }\n\n        return await callWithPromise(this.name + '.count', this.params);\n    }\n\n    /**\n     * Gets the count of matching elements.\n     * @param callback\n     * @returns {any}\n     */\n    getCount(callback) {\n        if (this._counter) {\n            return this._counter.getCount();\n        } else {\n            if (!callback) {\n                throw new Meteor.Error('not-allowed', 'You are on client so you must either provide a callback to get the count or subscribe first.');\n            } else {\n                return Meteor.call(this.name + '.count', this.params, callback);\n            }\n        }\n    }\n\n    /**\n     * Fetching non-reactive queries\n     * @param callback\n     * @private\n     */\n    _fetchStatic(callback) {\n        if (!callback) {\n            throw new Meteor.Error('not-allowed', 'You are on client so you must either provide a callback to get the data or subscribe first.');\n        }\n\n        Meteor.call(this.name, this.params, callback);\n    }\n\n    /**\n     * Fetching when we've got an active publication\n     *\n     * @param options\n     * @returns {*}\n     * @private\n     */\n    _fetchReactive(options = {}) {\n        let body = this.body;\n        if (this.params.$body) {\n            body = intersectDeep(body, this.params.$body);\n        }\n\n        body = prepareForProcess(body, this.params);\n        if (!options.allowSkip && body.$options && body.$options.skip) {\n            delete body.$options.skip;\n        }\n\n        return recursiveFetch(\n            createGraph(this.collection, body),\n            undefined, {\n                scoped: this.options.scoped,\n                subscriptionHandle: this.subscriptionHandle\n            });\n    }\n}\n"]},"sourceType":"script","hash":"bdd955ca7b9425124477b04cf70e7e1cafed5939"}
