{"metadata":{},"options":{"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/simiontomoiaga/git/server/packages/reywood:publish-composite/lib/publication.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","jsx",["flow",{}],["flow",{}],"objectRestSpread","objectRestSpread","dynamicImport","asyncGenerators","classProperties","classPrivateProperties"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.x86_64"},"sourceFileName":"packages/reywood:publish-composite/lib/publication.js","filename":"/Users/simiontomoiaga/git/server/packages/reywood:publish-composite/lib/publication.js","passPerPreset":false,"envName":"development","cwd":"/Users/simiontomoiaga/git/server","root":"/Users/simiontomoiaga/git/server","plugins":[{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"generateLetDeclarations":true,"enforceStrictMode":false}},{"key":"syntax-flow","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"transform-flow-strip-types","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"ClassPrivateProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"transform-runtime","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"transform-meteor-dynamic-import","visitor":{"_exploded":{},"_verified":{},"CallExpression":{"enter":[null]}},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"transform-modules-commonjs","visitor":{"Program":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"allowTopLevelThis":true,"strictMode":false,"loose":true}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]}},"options":{"loose":true}}],"presets":[],"generatorOpts":{"filename":"/Users/simiontomoiaga/git/server/packages/reywood:publish-composite/lib/publication.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/reywood:publish-composite/lib/publication.js"}},"code":"let Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\nlet Match, check;\nmodule.link(\"meteor/check\", {\n  Match(v) {\n    Match = v;\n  },\n\n  check(v) {\n    check = v;\n  }\n\n}, 1);\n\nlet _;\n\nmodule.link(\"meteor/underscore\", {\n  _(v) {\n    _ = v;\n  }\n\n}, 2);\nlet debugLog;\nmodule.link(\"./logging\", {\n  debugLog(v) {\n    debugLog = v;\n  }\n\n}, 3);\nlet PublishedDocumentList;\nmodule.link(\"./published_document_list\", {\n  default(v) {\n    PublishedDocumentList = v;\n  }\n\n}, 4);\n\nclass Publication {\n  constructor(subscription, options, args) {\n    check(options, {\n      find: Function,\n      children: Match.Optional([Object]),\n      collectionName: Match.Optional(String)\n    });\n    this.subscription = subscription;\n    this.options = options;\n    this.args = args || [];\n    this.childrenOptions = options.children || [];\n    this.publishedDocs = new PublishedDocumentList();\n    this.collectionName = options.collectionName;\n  }\n\n  publish() {\n    this.cursor = this._getCursor();\n\n    if (!this.cursor) {\n      return;\n    }\n\n    const collectionName = this._getCollectionName(); // Use Meteor.bindEnvironment to make sure the callbacks are run with the same\n    // environmentVariables as when publishing the \"parent\".\n    // It's only needed when publish is being recursively run.\n\n\n    this.observeHandle = this.cursor.observe({\n      added: Meteor.bindEnvironment(doc => {\n        const alreadyPublished = this.publishedDocs.has(doc._id);\n\n        if (alreadyPublished) {\n          debugLog('Publication.observeHandle.added', `${collectionName}:${doc._id} already published`);\n          this.publishedDocs.unflagForRemoval(doc._id);\n\n          this._republishChildrenOf(doc);\n\n          this.subscription.changed(collectionName, doc._id, doc);\n        } else {\n          this.publishedDocs.add(collectionName, doc._id);\n\n          this._publishChildrenOf(doc);\n\n          this.subscription.added(collectionName, doc);\n        }\n      }),\n      changed: Meteor.bindEnvironment(newDoc => {\n        debugLog('Publication.observeHandle.changed', `${collectionName}:${newDoc._id}`);\n\n        this._republishChildrenOf(newDoc);\n      }),\n      removed: doc => {\n        debugLog('Publication.observeHandle.removed', `${collectionName}:${doc._id}`);\n\n        this._removeDoc(collectionName, doc._id);\n      }\n    });\n    this.observeChangesHandle = this.cursor.observeChanges({\n      changed: (id, fields) => {\n        debugLog('Publication.observeChangesHandle.changed', `${collectionName}:${id}`);\n        this.subscription.changed(collectionName, id, fields);\n      }\n    });\n  }\n\n  unpublish() {\n    debugLog('Publication.unpublish', this._getCollectionName());\n\n    this._stopObservingCursor();\n\n    this._unpublishAllDocuments();\n  }\n\n  _republish() {\n    this._stopObservingCursor();\n\n    this.publishedDocs.flagAllForRemoval();\n    debugLog('Publication._republish', 'run .publish again');\n    this.publish();\n    debugLog('Publication._republish', 'unpublish docs from old cursor');\n\n    this._removeFlaggedDocs();\n  }\n\n  _getCursor() {\n    return this.options.find.apply(this.subscription.meteorSub, this.args);\n  }\n\n  _getCollectionName() {\n    return this.collectionName || this.cursor && this.cursor._getCollectionName();\n  }\n\n  _publishChildrenOf(doc) {\n    _.each(this.childrenOptions, function createChildPublication(options) {\n      const pub = new Publication(this.subscription, options, [doc].concat(this.args));\n      this.publishedDocs.addChildPub(doc._id, pub);\n      pub.publish();\n    }, this);\n  }\n\n  _republishChildrenOf(doc) {\n    this.publishedDocs.eachChildPub(doc._id, publication => {\n      publication.args[0] = doc;\n\n      publication._republish();\n    });\n  }\n\n  _unpublishAllDocuments() {\n    this.publishedDocs.eachDocument(doc => {\n      this._removeDoc(doc.collectionName, doc.docId);\n    }, this);\n  }\n\n  _stopObservingCursor() {\n    debugLog('Publication._stopObservingCursor', 'stop observing cursor');\n\n    if (this.observeHandle) {\n      this.observeHandle.stop();\n      delete this.observeHandle;\n    }\n\n    if (this.observeChangesHandle) {\n      this.observeChangesHandle.stop();\n      delete this.observeChangesHandle;\n    }\n  }\n\n  _removeFlaggedDocs() {\n    this.publishedDocs.eachDocument(doc => {\n      if (doc.isFlaggedForRemoval()) {\n        this._removeDoc(doc.collectionName, doc.docId);\n      }\n    }, this);\n  }\n\n  _removeDoc(collectionName, docId) {\n    this.subscription.removed(collectionName, docId);\n\n    this._unpublishChildrenOf(docId);\n\n    this.publishedDocs.remove(docId);\n  }\n\n  _unpublishChildrenOf(docId) {\n    debugLog('Publication._unpublishChildrenOf', `unpublishing children of ${this._getCollectionName()}:${docId}`);\n    this.publishedDocs.eachChildPub(docId, publication => {\n      publication.unpublish();\n    });\n  }\n\n}\n\nmodule.exportDefault(Publication);","map":{"version":3,"sources":["packages/reywood:publish-composite/lib/publication.js"],"names":["Meteor","module","link","v","Match","check","_","debugLog","PublishedDocumentList","default","Publication","constructor","subscription","options","args","find","Function","children","Optional","Object","collectionName","String","childrenOptions","publishedDocs","publish","cursor","_getCursor","_getCollectionName","observeHandle","observe","added","bindEnvironment","doc","alreadyPublished","has","_id","unflagForRemoval","_republishChildrenOf","changed","add","_publishChildrenOf","newDoc","removed","_removeDoc","observeChangesHandle","observeChanges","id","fields","unpublish","_stopObservingCursor","_unpublishAllDocuments","_republish","flagAllForRemoval","_removeFlaggedDocs","apply","meteorSub","each","createChildPublication","pub","concat","addChildPub","eachChildPub","publication","eachDocument","docId","stop","isFlaggedForRemoval","_unpublishChildrenOf","remove","exportDefault"],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { Match, check } from 'meteor/check';\nimport { _ } from 'meteor/underscore';\n\nimport { debugLog } from './logging';\nimport PublishedDocumentList from './published_document_list';\n\n\nclass Publication {\n    constructor(subscription, options, args) {\n        check(options, {\n            find: Function,\n            children: Match.Optional([Object]),\n            collectionName: Match.Optional(String),\n        });\n\n        this.subscription = subscription;\n        this.options = options;\n        this.args = args || [];\n        this.childrenOptions = options.children || [];\n        this.publishedDocs = new PublishedDocumentList();\n        this.collectionName = options.collectionName;\n    }\n\n    publish() {\n        this.cursor = this._getCursor();\n        if (!this.cursor) { return; }\n\n        const collectionName = this._getCollectionName();\n\n        // Use Meteor.bindEnvironment to make sure the callbacks are run with the same\n        // environmentVariables as when publishing the \"parent\".\n        // It's only needed when publish is being recursively run.\n        this.observeHandle = this.cursor.observe({\n            added: Meteor.bindEnvironment((doc) => {\n                const alreadyPublished = this.publishedDocs.has(doc._id);\n\n                if (alreadyPublished) {\n                    debugLog('Publication.observeHandle.added', `${collectionName}:${doc._id} already published`);\n                    this.publishedDocs.unflagForRemoval(doc._id);\n                    this._republishChildrenOf(doc);\n                    this.subscription.changed(collectionName, doc._id, doc);\n                } else {\n                    this.publishedDocs.add(collectionName, doc._id);\n                    this._publishChildrenOf(doc);\n                    this.subscription.added(collectionName, doc);\n                }\n            }),\n            changed: Meteor.bindEnvironment((newDoc) => {\n                debugLog('Publication.observeHandle.changed', `${collectionName}:${newDoc._id}`);\n                this._republishChildrenOf(newDoc);\n            }),\n            removed: (doc) => {\n                debugLog('Publication.observeHandle.removed', `${collectionName}:${doc._id}`);\n                this._removeDoc(collectionName, doc._id);\n            },\n        });\n\n        this.observeChangesHandle = this.cursor.observeChanges({\n            changed: (id, fields) => {\n                debugLog('Publication.observeChangesHandle.changed', `${collectionName}:${id}`);\n                this.subscription.changed(collectionName, id, fields);\n            },\n        });\n    }\n\n    unpublish() {\n        debugLog('Publication.unpublish', this._getCollectionName());\n        this._stopObservingCursor();\n        this._unpublishAllDocuments();\n    }\n\n    _republish() {\n        this._stopObservingCursor();\n\n        this.publishedDocs.flagAllForRemoval();\n\n        debugLog('Publication._republish', 'run .publish again');\n        this.publish();\n\n        debugLog('Publication._republish', 'unpublish docs from old cursor');\n        this._removeFlaggedDocs();\n    }\n\n    _getCursor() {\n        return this.options.find.apply(this.subscription.meteorSub, this.args);\n    }\n\n    _getCollectionName() {\n        return this.collectionName || (this.cursor && this.cursor._getCollectionName());\n    }\n\n    _publishChildrenOf(doc) {\n        _.each(this.childrenOptions, function createChildPublication(options) {\n            const pub = new Publication(this.subscription, options, [doc].concat(this.args));\n            this.publishedDocs.addChildPub(doc._id, pub);\n            pub.publish();\n        }, this);\n    }\n\n    _republishChildrenOf(doc) {\n        this.publishedDocs.eachChildPub(doc._id, (publication) => {\n            publication.args[0] = doc;\n            publication._republish();\n        });\n    }\n\n    _unpublishAllDocuments() {\n        this.publishedDocs.eachDocument((doc) => {\n            this._removeDoc(doc.collectionName, doc.docId);\n        }, this);\n    }\n\n    _stopObservingCursor() {\n        debugLog('Publication._stopObservingCursor', 'stop observing cursor');\n\n        if (this.observeHandle) {\n            this.observeHandle.stop();\n            delete this.observeHandle;\n        }\n\n        if (this.observeChangesHandle) {\n            this.observeChangesHandle.stop();\n            delete this.observeChangesHandle;\n        }\n    }\n\n    _removeFlaggedDocs() {\n        this.publishedDocs.eachDocument((doc) => {\n            if (doc.isFlaggedForRemoval()) {\n                this._removeDoc(doc.collectionName, doc.docId);\n            }\n        }, this);\n    }\n\n    _removeDoc(collectionName, docId) {\n        this.subscription.removed(collectionName, docId);\n        this._unpublishChildrenOf(docId);\n        this.publishedDocs.remove(docId);\n    }\n\n    _unpublishChildrenOf(docId) {\n        debugLog('Publication._unpublishChildrenOf', `unpublishing children of ${this._getCollectionName()}:${docId}`);\n\n        this.publishedDocs.eachChildPub(docId, (publication) => {\n            publication.unpublish();\n        });\n    }\n}\n\nexport default Publication;\n"]},"sourceType":"script","hash":"b3b8428068b95c13c6b282f25f3c89e6af473c5f"}
