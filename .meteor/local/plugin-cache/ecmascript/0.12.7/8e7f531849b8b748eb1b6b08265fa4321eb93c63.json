{"metadata":{},"options":{"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/simiontomoiaga/git/server/packages/cultofcoders:grapher/lib/links/linker.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","jsx",["flow",{}],["flow",{}],"objectRestSpread","objectRestSpread","dynamicImport","asyncGenerators","classProperties","classPrivateProperties"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.x86_64"},"sourceFileName":"packages/cultofcoders:grapher/lib/links/linker.js","filename":"/Users/simiontomoiaga/git/server/packages/cultofcoders:grapher/lib/links/linker.js","passPerPreset":false,"envName":"development","cwd":"/Users/simiontomoiaga/git/server","root":"/Users/simiontomoiaga/git/server","plugins":[{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"generateLetDeclarations":true,"enforceStrictMode":false}},{"key":"syntax-flow","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"transform-flow-strip-types","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"ClassPrivateProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"transform-runtime","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"transform-meteor-dynamic-import","visitor":{"_exploded":{},"_verified":{},"CallExpression":{"enter":[null]}},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"transform-modules-commonjs","visitor":{"Program":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"allowTopLevelThis":true,"strictMode":false,"loose":true}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]}},"options":{"loose":true}}],"presets":[],"generatorOpts":{"filename":"/Users/simiontomoiaga/git/server/packages/cultofcoders:grapher/lib/links/linker.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/cultofcoders:grapher/lib/links/linker.js"}},"code":"module.export({\n  default: () => Linker\n});\nlet LinkMany;\nmodule.link(\"./linkTypes/linkMany.js\", {\n  default(v) {\n    LinkMany = v;\n  }\n\n}, 0);\nlet LinkManyMeta;\nmodule.link(\"./linkTypes/linkManyMeta.js\", {\n  default(v) {\n    LinkManyMeta = v;\n  }\n\n}, 1);\nlet LinkOne;\nmodule.link(\"./linkTypes/linkOne.js\", {\n  default(v) {\n    LinkOne = v;\n  }\n\n}, 2);\nlet LinkOneMeta;\nmodule.link(\"./linkTypes/linkOneMeta.js\", {\n  default(v) {\n    LinkOneMeta = v;\n  }\n\n}, 3);\nlet LinkConfigSchema, LinkConfigDefaults;\nmodule.link(\"./config.schema.js\", {\n  LinkConfigSchema(v) {\n    LinkConfigSchema = v;\n  },\n\n  LinkConfigDefaults(v) {\n    LinkConfigDefaults = v;\n  }\n\n}, 4);\nlet smartArguments;\nmodule.link(\"./linkTypes/lib/smartArguments\", {\n  default(v) {\n    smartArguments = v;\n  }\n\n}, 5);\nlet dot;\nmodule.link(\"dot-object\", {\n  default(v) {\n    dot = v;\n  }\n\n}, 6);\nlet check;\nmodule.link(\"meteor/check\", {\n  check(v) {\n    check = v;\n  }\n\n}, 7);\n\nlet _;\n\nmodule.link(\"meteor/underscore\", {\n  _(v) {\n    _ = v;\n  }\n\n}, 8);\nlet access;\nmodule.link(\"fs\", {\n  access(v) {\n    access = v;\n  }\n\n}, 9);\n\nclass Linker {\n  /**\n   * @param mainCollection\n   * @param linkName\n   * @param linkConfig\n   */\n  constructor(mainCollection, linkName, linkConfig) {\n    this.mainCollection = mainCollection;\n    this.linkConfig = Object.assign({}, LinkConfigDefaults, linkConfig);\n    this.linkName = linkName; // check linkName must not exist in schema\n\n    this._validateAndClean(); // initialize cascade removal hooks.\n\n\n    this._initAutoremove();\n\n    this._initDenormalization();\n\n    if (this.isVirtual()) {\n      // if it's a virtual field make sure that when this is deleted, it will be removed from the references\n      if (!linkConfig.autoremove) {\n        this._handleReferenceRemovalForVirtualLinks();\n      }\n    } else {\n      this._initIndex();\n    }\n  }\n  /**\n   * Values which represent for the relation a single link\n   * @returns {string[]}\n   */\n\n\n  get oneTypes() {\n    return ['one', '1'];\n  }\n  /**\n   * Returns the strategies: one, many, one-meta, many-meta\n   * @returns {string}\n   */\n\n\n  get strategy() {\n    let strategy = this.isMany() ? 'many' : 'one';\n\n    if (this.linkConfig.metadata) {\n      strategy += '-meta';\n    }\n\n    return strategy;\n  }\n  /**\n   * Returns the field name in the document where the actual relationships are stored.\n   * @returns string\n   */\n\n\n  get linkStorageField() {\n    if (this.isVirtual()) {\n      return this.linkConfig.relatedLinker.linkStorageField;\n    }\n\n    return this.linkConfig.field;\n  }\n  /**\n   * The collection that is linked with the current collection\n   * @returns Mongo.Collection\n   */\n\n\n  getLinkedCollection() {\n    return this.linkConfig.collection;\n  }\n  /**\n   * If the relationship for this link is of \"many\" type.\n   */\n\n\n  isMany() {\n    return !this.isSingle();\n  }\n  /**\n   * If the relationship for this link contains metadata\n   */\n\n\n  isMeta() {\n    if (this.isVirtual()) {\n      return this.linkConfig.relatedLinker.isMeta();\n    }\n\n    return !!this.linkConfig.metadata;\n  }\n  /**\n   * @returns {boolean}\n   */\n\n\n  isSingle() {\n    if (this.isVirtual()) {\n      return this.linkConfig.relatedLinker.isSingle();\n    }\n\n    return _.contains(this.oneTypes, this.linkConfig.type);\n  }\n  /**\n   * @returns {boolean}\n   */\n\n\n  isVirtual() {\n    return !!this.linkConfig.inversedBy;\n  }\n  /**\n   * Should return a single result.\n   */\n\n\n  isOneResult() {\n    return this.isVirtual() && this.linkConfig.relatedLinker.linkConfig.unique || !this.isVirtual() && this.isSingle();\n  }\n  /**\n   * @param object\n   * @param collection To impersonate the getLinkedCollection() of the \"Linker\"\n   *\n   * @returns {LinkOne|LinkMany|LinkManyMeta|LinkOneMeta|LinkResolve}\n   */\n\n\n  createLink(object, collection = null) {\n    let helperClass = this._getHelperClass();\n\n    return new helperClass(this, object, collection);\n  }\n  /**\n   * @returns {*}\n   * @private\n   */\n\n\n  _validateAndClean() {\n    if (!this.linkConfig.collection) {\n      throw new Meteor.Error('invalid-config', `For the link ${this.linkName} you did not provide a collection.`);\n    }\n\n    if (typeof this.linkConfig.collection === 'string') {\n      const collectionName = this.linkConfig.collection;\n      this.linkConfig.collection = Mongo.Collection.get(collectionName);\n\n      if (!this.linkConfig.collection) {\n        throw new Meteor.Error('invalid-collection', `Could not find a collection with the name: ${collectionName}`);\n      }\n    }\n\n    if (this.isVirtual()) {\n      return this._prepareVirtual();\n    } else {\n      if (!this.linkConfig.type) {\n        this.linkConfig.type = 'one';\n      }\n\n      if (!this.linkConfig.field) {\n        this.linkConfig.field = this._generateFieldName();\n      } else {\n        if (this.linkConfig.field == this.linkName) {\n          throw new Meteor.Error('invalid-config', `For the link ${this.linkName} you must not use the same name for the field, otherwise it will cause conflicts when fetching data`);\n        }\n      }\n    }\n\n    check(this.linkConfig, LinkConfigSchema);\n  }\n  /**\n   * We need to apply same type of rules in this case.\n   * @private\n   */\n\n\n  _prepareVirtual() {\n    const {\n      collection,\n      inversedBy\n    } = this.linkConfig;\n    let linker = collection.getLinker(inversedBy);\n\n    if (!linker) {\n      // it is possible that the collection doesn't have a linker created yet.\n      // so we will create it on startup after all links have been defined\n      Meteor.startup(() => {\n        linker = collection.getLinker(inversedBy);\n\n        if (!linker) {\n          throw new Meteor.Error(`You tried setting up an inversed link in \"${this.mainCollection._name}\" pointing to collection: \"${collection._name}\" link: \"${inversedBy}\", but no such link was found. Maybe a typo ?`);\n        } else {\n          this._setupVirtualConfig(linker);\n        }\n      });\n    } else {\n      this._setupVirtualConfig(linker);\n    }\n  }\n  /**\n   * @param linker\n   * @private\n   */\n\n\n  _setupVirtualConfig(linker) {\n    const virtualLinkConfig = linker.linkConfig;\n\n    if (!virtualLinkConfig) {\n      throw new Meteor.Error(`There is no link-config for the related collection on ${inversedBy}. Make sure you added the direct links before specifying virtual ones.`);\n    }\n\n    _.extend(this.linkConfig, {\n      metadata: virtualLinkConfig.metadata,\n      relatedLinker: linker\n    });\n  }\n  /**\n   * Depending on the strategy, we create the proper helper class\n   * @private\n   */\n\n\n  _getHelperClass() {\n    switch (this.strategy) {\n      case 'many-meta':\n        return LinkManyMeta;\n\n      case 'many':\n        return LinkMany;\n\n      case 'one-meta':\n        return LinkOneMeta;\n\n      case 'one':\n        return LinkOne;\n    }\n\n    throw new Meteor.Error('invalid-strategy', `${this.strategy} is not a valid strategy`);\n  }\n  /**\n   * If field name not present, we generate it.\n   * @private\n   */\n\n\n  _generateFieldName() {\n    let cleanedCollectionName = this.linkConfig.collection._name.replace(/\\./g, '_');\n\n    let defaultFieldPrefix = this.linkName + '_' + cleanedCollectionName;\n\n    switch (this.strategy) {\n      case 'many-meta':\n        return `${defaultFieldPrefix}_metas`;\n\n      case 'many':\n        return `${defaultFieldPrefix}_ids`;\n\n      case 'one-meta':\n        return `${defaultFieldPrefix}_meta`;\n\n      case 'one':\n        return `${defaultFieldPrefix}_id`;\n    }\n  }\n  /**\n   * When a link that is declared virtual is removed, the reference will be removed from every other link.\n   * @private\n   */\n\n\n  _handleReferenceRemovalForVirtualLinks() {\n    this.mainCollection.after.remove((userId, doc) => {\n      // this problem may occur when you do a .remove() before Meteor.startup()\n      if (!this.linkConfig.relatedLinker) {\n        console.warn(`There was an error finding the link for removal for collection: \"${this.mainCollection._name}\" with link: \"${this.linkName}\". This may occur when you do a .remove() before Meteor.startup()`);\n        return;\n      }\n\n      const accessor = this.createLink(doc);\n\n      _.each(accessor.fetchAsArray(), linkedObj => {\n        const {\n          relatedLinker\n        } = this.linkConfig; // We do this check, to avoid self-referencing hell when defining virtual links\n        // Virtual links if not found \"compile-time\", we will try again to reprocess them on Meteor.startup\n        // if a removal happens before Meteor.startup this may fail\n\n        if (relatedLinker) {\n          let link = relatedLinker.createLink(linkedObj);\n\n          if (relatedLinker.isSingle()) {\n            link.unset();\n          } else {\n            link.remove(doc);\n          }\n        }\n      });\n    });\n  }\n\n  _initIndex() {\n    if (Meteor.isServer) {\n      let field = this.linkConfig.field;\n\n      if (this.linkConfig.metadata) {\n        field = field + '._id';\n      }\n\n      if (this.linkConfig.index) {\n        if (this.isVirtual()) {\n          throw new Meteor.Error('You cannot set index on an inversed link.');\n        }\n\n        let options;\n\n        if (this.linkConfig.unique) {\n          options = {\n            unique: true\n          };\n        }\n\n        this.mainCollection._ensureIndex({\n          [field]: 1\n        }, options);\n      } else {\n        if (this.linkConfig.unique) {\n          if (this.isVirtual()) {\n            throw new Meteor.Error('You cannot set unique property on an inversed link.');\n          }\n\n          this.mainCollection._ensureIndex({\n            [field]: 1\n          }, {\n            unique: true,\n            sparse: true\n          });\n        }\n      }\n    }\n  }\n\n  _initAutoremove() {\n    if (!this.linkConfig.autoremove) {\n      return;\n    }\n\n    if (!this.isVirtual()) {\n      this.mainCollection.after.remove((userId, doc) => {\n        this.getLinkedCollection().remove({\n          _id: {\n            $in: smartArguments.getIds(doc[this.linkStorageField])\n          }\n        });\n      });\n    } else {\n      this.mainCollection.after.remove((userId, doc) => {\n        const linker = this.mainCollection.getLink(doc, this.linkName);\n        const ids = linker.find({}, {\n          fields: {\n            _id: 1\n          }\n        }).fetch().map(item => item._id);\n        this.getLinkedCollection().remove({\n          _id: {\n            $in: ids\n          }\n        });\n      });\n    }\n  }\n  /**\n   * Initializes denormalization using herteby:denormalize\n   * @private\n   */\n\n\n  _initDenormalization() {\n    if (!this.linkConfig.denormalize || !Meteor.isServer) {\n      return;\n    }\n\n    const packageExists = !!Package['herteby:denormalize'];\n\n    if (!packageExists) {\n      throw new Meteor.Error('missing-package', `Please add the herteby:denormalize package to your Meteor application in order to make caching work`);\n    }\n\n    const {\n      field,\n      body,\n      bypassSchema\n    } = this.linkConfig.denormalize;\n    let cacheConfig;\n    let referenceFieldSuffix = '';\n\n    if (this.isMeta()) {\n      referenceFieldSuffix = this.isSingle() ? '._id' : ':_id';\n    }\n\n    if (this.isVirtual()) {\n      let inversedLink = this.linkConfig.relatedLinker.linkConfig;\n      let type = inversedLink.type == 'many' ? 'many-inverse' : 'inversed';\n      cacheConfig = {\n        type: type,\n        collection: this.linkConfig.collection,\n        fields: body,\n        referenceField: inversedLink.field + referenceFieldSuffix,\n        cacheField: field,\n        bypassSchema: !!bypassSchema\n      };\n    } else {\n      cacheConfig = {\n        type: this.linkConfig.type,\n        collection: this.linkConfig.collection,\n        fields: body,\n        referenceField: this.linkConfig.field + referenceFieldSuffix,\n        cacheField: field,\n        bypassSchema: !!bypassSchema\n      };\n    }\n\n    if (this.isVirtual()) {\n      Meteor.startup(() => {\n        this.mainCollection.cache(cacheConfig);\n      });\n    } else {\n      this.mainCollection.cache(cacheConfig);\n    }\n  }\n  /**\n   * Verifies if this linker is denormalized. It can be denormalized from the inverse side as well.\n   *\n   * @returns {boolean}\n   * @private\n   */\n\n\n  isDenormalized() {\n    return !!this.linkConfig.denormalize;\n  }\n  /**\n   * Verifies if the body of the linked element does not contain fields outside the cache body\n   *\n   * @param body\n   * @returns {boolean}\n   * @private\n   */\n\n\n  isSubBodyDenormalized(body) {\n    const cacheBody = this.linkConfig.denormalize.body;\n\n    const cacheBodyFields = _.keys(dot.dot(cacheBody));\n\n    const bodyFields = _.keys(dot.dot(_.omit(body, '_id')));\n\n    return _.difference(bodyFields, cacheBodyFields).length === 0;\n  }\n\n}","map":{"version":3,"sources":["packages/cultofcoders:grapher/lib/links/linker.js"],"names":["module","export","default","Linker","LinkMany","link","v","LinkManyMeta","LinkOne","LinkOneMeta","LinkConfigSchema","LinkConfigDefaults","smartArguments","dot","check","_","access","constructor","mainCollection","linkName","linkConfig","Object","assign","_validateAndClean","_initAutoremove","_initDenormalization","isVirtual","autoremove","_handleReferenceRemovalForVirtualLinks","_initIndex","oneTypes","strategy","isMany","metadata","linkStorageField","relatedLinker","field","getLinkedCollection","collection","isSingle","isMeta","contains","type","inversedBy","isOneResult","unique","createLink","object","helperClass","_getHelperClass","Meteor","Error","collectionName","Mongo","Collection","get","_prepareVirtual","_generateFieldName","linker","getLinker","startup","_name","_setupVirtualConfig","virtualLinkConfig","extend","cleanedCollectionName","replace","defaultFieldPrefix","after","remove","userId","doc","console","warn","accessor","each","fetchAsArray","linkedObj","unset","isServer","index","options","_ensureIndex","sparse","_id","$in","getIds","getLink","ids","find","fields","fetch","map","item","denormalize","packageExists","Package","body","bypassSchema","cacheConfig","referenceFieldSuffix","inversedLink","referenceField","cacheField","cache","isDenormalized","isSubBodyDenormalized","cacheBody","cacheBodyFields","keys","bodyFields","omit","difference","length"],"mappings":"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","sourcesContent":["import LinkMany from './linkTypes/linkMany.js';\nimport LinkManyMeta from './linkTypes/linkManyMeta.js';\nimport LinkOne from './linkTypes/linkOne.js';\nimport LinkOneMeta from './linkTypes/linkOneMeta.js';\nimport { LinkConfigSchema, LinkConfigDefaults } from './config.schema.js';\nimport smartArguments from './linkTypes/lib/smartArguments';\nimport dot from 'dot-object';\nimport { check } from 'meteor/check';\nimport { _ } from 'meteor/underscore';\nimport { access } from 'fs';\n\nexport default class Linker {\n    /**\n     * @param mainCollection\n     * @param linkName\n     * @param linkConfig\n     */\n    constructor(mainCollection, linkName, linkConfig) {\n        this.mainCollection = mainCollection;\n        this.linkConfig = Object.assign({}, LinkConfigDefaults, linkConfig);\n        this.linkName = linkName;\n\n        // check linkName must not exist in schema\n        this._validateAndClean();\n\n        // initialize cascade removal hooks.\n        this._initAutoremove();\n        this._initDenormalization();\n\n        if (this.isVirtual()) {\n            // if it's a virtual field make sure that when this is deleted, it will be removed from the references\n            if (!linkConfig.autoremove) {\n                this._handleReferenceRemovalForVirtualLinks();\n            }\n        } else {\n            this._initIndex();\n        }\n    }\n\n    /**\n     * Values which represent for the relation a single link\n     * @returns {string[]}\n     */\n    get oneTypes() {\n        return ['one', '1'];\n    }\n\n    /**\n     * Returns the strategies: one, many, one-meta, many-meta\n     * @returns {string}\n     */\n    get strategy() {\n        let strategy = this.isMany() ? 'many' : 'one';\n        if (this.linkConfig.metadata) {\n            strategy += '-meta';\n        }\n\n        return strategy;\n    }\n\n    /**\n     * Returns the field name in the document where the actual relationships are stored.\n     * @returns string\n     */\n    get linkStorageField() {\n        if (this.isVirtual()) {\n            return this.linkConfig.relatedLinker.linkStorageField;\n        }\n\n        return this.linkConfig.field;\n    }\n\n    /**\n     * The collection that is linked with the current collection\n     * @returns Mongo.Collection\n     */\n    getLinkedCollection() {\n        return this.linkConfig.collection;\n    }\n\n    /**\n     * If the relationship for this link is of \"many\" type.\n     */\n    isMany() {\n        return !this.isSingle();\n    }\n\n    /**\n     * If the relationship for this link contains metadata\n     */\n    isMeta() {\n        if (this.isVirtual()) {\n            return this.linkConfig.relatedLinker.isMeta();\n        }\n\n        return !!this.linkConfig.metadata;\n    }\n\n    /**\n     * @returns {boolean}\n     */\n    isSingle() {\n        if (this.isVirtual()) {\n            return this.linkConfig.relatedLinker.isSingle();\n        }\n\n        return _.contains(this.oneTypes, this.linkConfig.type);\n    }\n\n    /**\n     * @returns {boolean}\n     */\n    isVirtual() {\n        return !!this.linkConfig.inversedBy;\n    }\n\n    /**\n     * Should return a single result.\n     */\n    isOneResult() {\n        return (\n            (this.isVirtual() &&\n                this.linkConfig.relatedLinker.linkConfig.unique) ||\n            (!this.isVirtual() && this.isSingle())\n        );\n    }\n\n    /**\n     * @param object\n     * @param collection To impersonate the getLinkedCollection() of the \"Linker\"\n     *\n     * @returns {LinkOne|LinkMany|LinkManyMeta|LinkOneMeta|LinkResolve}\n     */\n    createLink(object, collection = null) {\n        let helperClass = this._getHelperClass();\n\n        return new helperClass(this, object, collection);\n    }\n\n    /**\n     * @returns {*}\n     * @private\n     */\n    _validateAndClean() {\n        if (!this.linkConfig.collection) {\n            throw new Meteor.Error(\n                'invalid-config',\n                `For the link ${\n                    this.linkName\n                } you did not provide a collection.`\n            );\n        }\n\n        if (typeof this.linkConfig.collection === 'string') {\n            const collectionName = this.linkConfig.collection;\n            this.linkConfig.collection = Mongo.Collection.get(collectionName);\n\n            if (!this.linkConfig.collection) {\n                throw new Meteor.Error(\n                    'invalid-collection',\n                    `Could not find a collection with the name: ${collectionName}`\n                );\n            }\n        }\n\n        if (this.isVirtual()) {\n            return this._prepareVirtual();\n        } else {\n            if (!this.linkConfig.type) {\n                this.linkConfig.type = 'one';\n            }\n\n            if (!this.linkConfig.field) {\n                this.linkConfig.field = this._generateFieldName();\n            } else {\n                if (this.linkConfig.field == this.linkName) {\n                    throw new Meteor.Error(\n                        'invalid-config',\n                        `For the link ${\n                            this.linkName\n                        } you must not use the same name for the field, otherwise it will cause conflicts when fetching data`\n                    );\n                }\n            }\n        }\n\n        check(this.linkConfig, LinkConfigSchema);\n    }\n\n    /**\n     * We need to apply same type of rules in this case.\n     * @private\n     */\n    _prepareVirtual() {\n        const { collection, inversedBy } = this.linkConfig;\n        let linker = collection.getLinker(inversedBy);\n\n        if (!linker) {\n            // it is possible that the collection doesn't have a linker created yet.\n            // so we will create it on startup after all links have been defined\n            Meteor.startup(() => {\n                linker = collection.getLinker(inversedBy);\n                if (!linker) {\n                    throw new Meteor.Error(\n                        `You tried setting up an inversed link in \"${\n                            this.mainCollection._name\n                        }\" pointing to collection: \"${\n                            collection._name\n                        }\" link: \"${inversedBy}\", but no such link was found. Maybe a typo ?`\n                    );\n                } else {\n                    this._setupVirtualConfig(linker);\n                }\n            });\n        } else {\n            this._setupVirtualConfig(linker);\n        }\n    }\n\n    /**\n     * @param linker\n     * @private\n     */\n    _setupVirtualConfig(linker) {\n        const virtualLinkConfig = linker.linkConfig;\n\n        if (!virtualLinkConfig) {\n            throw new Meteor.Error(\n                `There is no link-config for the related collection on ${inversedBy}. Make sure you added the direct links before specifying virtual ones.`\n            );\n        }\n\n        _.extend(this.linkConfig, {\n            metadata: virtualLinkConfig.metadata,\n            relatedLinker: linker,\n        });\n    }\n\n    /**\n     * Depending on the strategy, we create the proper helper class\n     * @private\n     */\n    _getHelperClass() {\n        switch (this.strategy) {\n            case 'many-meta':\n                return LinkManyMeta;\n            case 'many':\n                return LinkMany;\n            case 'one-meta':\n                return LinkOneMeta;\n            case 'one':\n                return LinkOne;\n        }\n\n        throw new Meteor.Error(\n            'invalid-strategy',\n            `${this.strategy} is not a valid strategy`\n        );\n    }\n\n    /**\n     * If field name not present, we generate it.\n     * @private\n     */\n    _generateFieldName() {\n        let cleanedCollectionName = this.linkConfig.collection._name.replace(\n            /\\./g,\n            '_'\n        );\n        let defaultFieldPrefix = this.linkName + '_' + cleanedCollectionName;\n\n        switch (this.strategy) {\n            case 'many-meta':\n                return `${defaultFieldPrefix}_metas`;\n            case 'many':\n                return `${defaultFieldPrefix}_ids`;\n            case 'one-meta':\n                return `${defaultFieldPrefix}_meta`;\n            case 'one':\n                return `${defaultFieldPrefix}_id`;\n        }\n    }\n\n    /**\n     * When a link that is declared virtual is removed, the reference will be removed from every other link.\n     * @private\n     */\n    _handleReferenceRemovalForVirtualLinks() {\n        this.mainCollection.after.remove((userId, doc) => {\n            // this problem may occur when you do a .remove() before Meteor.startup()\n            if (!this.linkConfig.relatedLinker) {\n                console.warn(\n                    `There was an error finding the link for removal for collection: \"${\n                        this.mainCollection._name\n                    }\" with link: \"${\n                        this.linkName\n                    }\". This may occur when you do a .remove() before Meteor.startup()`\n                );\n                return;\n            }\n\n            const accessor = this.createLink(doc);\n\n            _.each(accessor.fetchAsArray(), linkedObj => {\n                const { relatedLinker } = this.linkConfig;\n                // We do this check, to avoid self-referencing hell when defining virtual links\n                // Virtual links if not found \"compile-time\", we will try again to reprocess them on Meteor.startup\n                // if a removal happens before Meteor.startup this may fail\n                if (relatedLinker) {\n                    let link = relatedLinker.createLink(linkedObj);\n\n                    if (relatedLinker.isSingle()) {\n                        link.unset();\n                    } else {\n                        link.remove(doc);\n                    }\n                }\n            });\n        });\n    }\n\n    _initIndex() {\n        if (Meteor.isServer) {\n            let field = this.linkConfig.field;\n            if (this.linkConfig.metadata) {\n                field = field + '._id';\n            }\n\n            if (this.linkConfig.index) {\n                if (this.isVirtual()) {\n                    throw new Meteor.Error(\n                        'You cannot set index on an inversed link.'\n                    );\n                }\n\n                let options;\n                if (this.linkConfig.unique) {\n                    options = { unique: true };\n                }\n\n                this.mainCollection._ensureIndex({ [field]: 1 }, options);\n            } else {\n                if (this.linkConfig.unique) {\n                    if (this.isVirtual()) {\n                        throw new Meteor.Error(\n                            'You cannot set unique property on an inversed link.'\n                        );\n                    }\n\n                    this.mainCollection._ensureIndex(\n                        {\n                            [field]: 1,\n                        },\n                        { unique: true, sparse: true }\n                    );\n                }\n            }\n        }\n    }\n\n    _initAutoremove() {\n        if (!this.linkConfig.autoremove) {\n            return;\n        }\n\n        if (!this.isVirtual()) {\n            this.mainCollection.after.remove((userId, doc) => {\n                this.getLinkedCollection().remove({\n                    _id: {\n                        $in: smartArguments.getIds(doc[this.linkStorageField]),\n                    },\n                });\n            });\n        } else {\n            this.mainCollection.after.remove((userId, doc) => {\n                const linker = this.mainCollection.getLink(doc, this.linkName);\n                const ids = linker\n                    .find({}, { fields: { _id: 1 } })\n                    .fetch()\n                    .map(item => item._id);\n\n                this.getLinkedCollection().remove({\n                    _id: { $in: ids },\n                });\n            });\n        }\n    }\n\n    /**\n     * Initializes denormalization using herteby:denormalize\n     * @private\n     */\n    _initDenormalization() {\n        if (!this.linkConfig.denormalize || !Meteor.isServer) {\n            return;\n        }\n\n        const packageExists = !!Package['herteby:denormalize'];\n        if (!packageExists) {\n            throw new Meteor.Error(\n                'missing-package',\n                `Please add the herteby:denormalize package to your Meteor application in order to make caching work`\n            );\n        }\n\n        const { field, body, bypassSchema } = this.linkConfig.denormalize;\n        let cacheConfig;\n\n        let referenceFieldSuffix = '';\n        if (this.isMeta()) {\n            referenceFieldSuffix = this.isSingle() ? '._id' : ':_id';\n        }\n\n        if (this.isVirtual()) {\n            let inversedLink = this.linkConfig.relatedLinker.linkConfig;\n\n            let type =\n                inversedLink.type == 'many' ? 'many-inverse' : 'inversed';\n\n            cacheConfig = {\n                type: type,\n                collection: this.linkConfig.collection,\n                fields: body,\n                referenceField: inversedLink.field + referenceFieldSuffix,\n                cacheField: field,\n                bypassSchema: !!bypassSchema,\n            };\n        } else {\n            cacheConfig = {\n                type: this.linkConfig.type,\n                collection: this.linkConfig.collection,\n                fields: body,\n                referenceField: this.linkConfig.field + referenceFieldSuffix,\n                cacheField: field,\n                bypassSchema: !!bypassSchema,\n            };\n        }\n\n        if (this.isVirtual()) {\n            Meteor.startup(() => {\n                this.mainCollection.cache(cacheConfig);\n            });\n        } else {\n            this.mainCollection.cache(cacheConfig);\n        }\n    }\n\n    /**\n     * Verifies if this linker is denormalized. It can be denormalized from the inverse side as well.\n     *\n     * @returns {boolean}\n     * @private\n     */\n    isDenormalized() {\n        return !!this.linkConfig.denormalize;\n    }\n\n    /**\n     * Verifies if the body of the linked element does not contain fields outside the cache body\n     *\n     * @param body\n     * @returns {boolean}\n     * @private\n     */\n    isSubBodyDenormalized(body) {\n        const cacheBody = this.linkConfig.denormalize.body;\n\n        const cacheBodyFields = _.keys(dot.dot(cacheBody));\n        const bodyFields = _.keys(dot.dot(_.omit(body, '_id')));\n\n        return _.difference(bodyFields, cacheBodyFields).length === 0;\n    }\n}\n"]},"sourceType":"script","hash":"8e7f531849b8b748eb1b6b08265fa4321eb93c63"}
